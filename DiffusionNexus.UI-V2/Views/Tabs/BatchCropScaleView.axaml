<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:DiffusionNexus.UI.ViewModels.Tabs"
             xmlns:vms="using:DiffusionNexus.UI.ViewModels"
             xmlns:converters="using:DiffusionNexus.UI.Converters"
             mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="700"
             x:Class="DiffusionNexus.UI.Views.Tabs.BatchCropScaleView"
             x:DataType="vm:BatchCropScaleTabViewModel">

    <UserControl.Resources>
        <converters:BoolToAccentBrushConverter x:Key="BoolToAccentBrushConverter"/>
    </UserControl.Resources>

    <UserControl.Styles>
        <Style Selector="Border.Card">
            <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="16"/>
            <Setter Property="Margin" Value="0,0,0,16"/>
        </Style>

        <Style Selector="TextBlock.Header">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="0,0,0,12"/>
        </Style>

        <Style Selector="TextBlock.SubText">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Opacity" Value="0.6"/>
        </Style>

        <Style Selector="Button.primary-btn">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,0%">
                        <GradientStop Color="#667eea" Offset="0"/>
                        <GradientStop Color="#764ba2" Offset="1"/>
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="Padding" Value="32,12"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <Style Selector="Button.primary-btn:pointerover">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,0%">
                        <GradientStop Color="#764ba2" Offset="0"/>
                        <GradientStop Color="#667eea" Offset="1"/>
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
        </Style>

        <Style Selector="Button.primary-btn:disabled">
            <Setter Property="Background" Value="#555577"/>
            <Setter Property="Foreground" Value="#888888"/>
        </Style>
    </UserControl.Styles>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="24">

            <!-- Source Selection Card -->
            <Border Classes="Card">
                <StackPanel Spacing="16">
                    <TextBlock Text="Image Source" Classes="Header" Margin="0"/>

                    <!-- Dataset Selection -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="Select Dataset" FontWeight="SemiBold"/>
                        <Grid ColumnDefinitions="*,Auto,*,Auto" ColumnSpacing="8">
                            <ComboBox Grid.Column="0"
                                      ItemsSource="{Binding Datasets}"
                                      SelectedItem="{Binding SelectedDataset}"
                                      IsEnabled="{Binding !IsProcessing}"
                                      PlaceholderText="Select a dataset..."
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate DataType="vms:DatasetCardViewModel">
                                        <TextBlock Text="{Binding Name}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                            <ComboBox Grid.Column="1"
                                      ItemsSource="{Binding VersionItems}"
                                      SelectedItem="{Binding SelectedVersion}"
                                      IsEnabled="{Binding !IsProcessing}"
                                      IsVisible="{Binding SelectedDataset, Converter={x:Static ObjectConverters.IsNotNull}}"
                                      MinWidth="140">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate DataType="vms:EditorVersionItem">
                                        <TextBlock Text="{Binding DisplayText}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                            <Button Grid.Column="3"
                                    Content="Clear"
                                    Command="{Binding ClearDatasetSelectionCommand}"
                                    IsEnabled="{Binding !IsProcessing}"
                                    IsVisible="{Binding SelectedDataset, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                        </Grid>
                    </StackPanel>

                    <!-- OR Separator -->
                    <Grid ColumnDefinitions="*,Auto,*" Margin="0,8">
                        <Separator Grid.Column="0" VerticalAlignment="Center" Opacity="0.3"/>
                        <TextBlock Grid.Column="1" Text="OR" Margin="16,0" Opacity="0.6" FontWeight="SemiBold"/>
                        <Separator Grid.Column="2" VerticalAlignment="Center" Opacity="0.3"/>
                    </Grid>

                    <!-- Source Folder Selection -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="Source Folder" FontWeight="SemiBold"/>
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <TextBox Grid.Column="0"
                                     Text="{Binding SourceFolder}"
                                     Watermark="Select a folder containing images..."
                                     IsEnabled="{Binding !IsProcessing}"/>
                            <Button Grid.Column="1"
                                    x:Name="BrowseSourceButton"
                                    Content="Browse..."
                                    IsEnabled="{Binding !IsProcessing}"/>
                        </Grid>
                    </StackPanel>

                    <!-- Image Count Display -->
                    <TextBlock Classes="SubText" Margin="0,8,0,0">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="Found {0} images in {1} files">
                                <Binding Path="ImageFiles"/>
                                <Binding Path="TotalFiles"/>
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- Fit Mode Card -->
            <Border Classes="Card">
                <StackPanel Spacing="12">
                    <TextBlock Text="Fit Mode" Classes="Header" Margin="0"/>
                    
                    <!-- Crop vs Pad Toggle - Side by Side -->
                    <Grid ColumnDefinitions="*,16,*" Margin="0,0,0,8">
                        <!-- Crop Option -->
                        <Border Grid.Column="0"
                                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                                CornerRadius="8"
                                Padding="16"
                                BorderThickness="2"
                                VerticalAlignment="Top"
                                BorderBrush="{Binding !UsePadding, Converter={StaticResource BoolToAccentBrushConverter}}">
                            <RadioButton GroupName="FitMode"
                                         IsChecked="{Binding !UsePadding}"
                                         IsEnabled="{Binding !IsProcessing}">
                                <StackPanel Spacing="4">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <Border Background="#E53935" CornerRadius="4" Padding="6,2" VerticalAlignment="Center">
                                            <TextBlock Text="CROP" FontSize="10" FontWeight="Bold" Foreground="White"/>
                                        </Border>
                                        <TextBlock Text="Crop" FontSize="16" FontWeight="Bold" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <TextBlock Text="Remove pixels to fit aspect ratio. May cut off parts of the image." 
                                               Classes="SubText" 
                                               TextWrapping="Wrap"/>
                                </StackPanel>
                            </RadioButton>
                        </Border>
                        
                        <!-- Pad Option with Inline Settings -->
                        <StackPanel Grid.Column="2" Spacing="8" VerticalAlignment="Top">
                            <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                                    CornerRadius="8"
                                    Padding="16"
                                    BorderThickness="2"
                                    BorderBrush="{Binding UsePadding, Converter={StaticResource BoolToAccentBrushConverter}}">
                                <RadioButton GroupName="FitMode"
                                             IsChecked="{Binding UsePadding}"
                                             IsEnabled="{Binding !IsProcessing}">
                                    <StackPanel Spacing="4">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <Border Background="#1E88E5" CornerRadius="4" Padding="6,2" VerticalAlignment="Center">
                                                <TextBlock Text="PAD" FontSize="10" FontWeight="Bold" Foreground="White"/>
                                            </Border>
                                            <TextBlock Text="Pad (Letterbox)" FontSize="16" FontWeight="Bold" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <TextBlock Text="Add canvas to preserve entire image. Nothing is lost." 
                                                   Classes="SubText" 
                                                   TextWrapping="Wrap"/>
                                    </StackPanel>
                                </RadioButton>
                            </Border>

                            <!-- Padding Fill Options (directly below Pad option) -->
                            <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                                    CornerRadius="6"
                                    Padding="12"
                                    IsVisible="{Binding IsPadMode}">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="Padding Fill Style" FontWeight="SemiBold"/>
                                    <ComboBox ItemsSource="{Binding PaddingFillOptions}"
                                              SelectedItem="{Binding SelectedPaddingFill}"
                                              IsEnabled="{Binding !IsProcessing}"
                                              HorizontalAlignment="Stretch">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate DataType="vm:PaddingFillOption">
                                                <TextBlock Text="{Binding DisplayName}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <TextBlock Classes="SubText" 
                                               TextWrapping="Wrap">
                                        <TextBlock.Text>
                                            <Binding Path="SelectedPaddingFill.Mode">
                                                <Binding.Converter>
                                                    <vm:PaddingFillDescriptionConverter/>
                                                </Binding.Converter>
                                            </Binding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Bucket Selection Card -->
            <Border Classes="Card">
                <StackPanel Spacing="12">
                    <Grid ColumnDefinitions="*,Auto,Auto">
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Aspect Ratio Buckets"
                                       Classes="Header"
                                       Margin="0"/>
                            <TextBlock Classes="SubText" Margin="0,4,0,0">
                                <TextBlock.Text>
                                    <Binding Path="UsePadding">
                                        <Binding.Converter>
                                            <vm:BucketDescriptionConverter/>
                                        </Binding.Converter>
                                    </Binding>
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                        <Button Grid.Column="1"
                                Content="Select All"
                                Command="{Binding SelectAllBucketsCommand}"
                                Margin="0,0,8,0"
                                IsEnabled="{Binding !IsProcessing}"/>
                        <Button Grid.Column="2"
                                Content="Deselect All"
                                Command="{Binding DeselectAllBucketsCommand}"
                                IsEnabled="{Binding !IsProcessing}"/>
                    </Grid>

                    <ItemsControl ItemsSource="{Binding BucketOptions}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="vm:BucketOption">
                                <ToggleButton IsChecked="{Binding IsSelected}"
                                              Content="{Binding DisplayName}"
                                              Margin="4"
                                              Padding="12,8"
                                              MinWidth="60"
                                              HorizontalContentAlignment="Center"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <TextBlock Text="Select at least one bucket to enable processing"
                               Classes="SubText"
                               Foreground="{DynamicResource SystemControlErrorTextForegroundBrush}"
                               IsVisible="{Binding !HasSelectedBuckets}"/>

                    <!-- Resolution Selection -->
                    <Separator Margin="0,8" Opacity="0.2"/>
                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="12">
                        <TextBlock Text="Target Resolution:"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding ResolutionOptions}"
                                  SelectedItem="{Binding SelectedResolution}"
                                  IsEnabled="{Binding !IsProcessing}"
                                  MinWidth="200">
                            <ComboBox.ItemTemplate>
                                <DataTemplate DataType="vm:ResolutionOption">
                                    <TextBlock Text="{Binding DisplayName}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <TextBox Grid.Column="2"
                                 Text="{Binding CustomResolution}"
                                 Watermark="Custom"
                                 IsEnabled="{Binding !IsProcessing}"
                                 Width="100"/>
                        <TextBlock Grid.Column="3"
                                   Text="px"
                                   VerticalAlignment="Center"
                                   Opacity="0.7"/>
                    </Grid>
                    <TextBlock Classes="SubText">
                        <TextBlock.Text>
                            <Binding Path="UsePadding">
                                <Binding.Converter>
                                    <vm:ScaleDescriptionConverter/>
                                </Binding.Converter>
                            </Binding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- Target Destination Card -->
            <Border Classes="Card">
                <StackPanel Spacing="16">
                    <TextBlock Text="Target Destination" Classes="Header" Margin="0"/>

                    <!-- Increment Version Option (only when dataset is selected) -->
                    <StackPanel Spacing="8" IsVisible="{Binding CanIncrementVersion}">
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <CheckBox Content="{Binding IncrementVersionDisplayText}"
                                      IsChecked="{Binding UseIncrementVersion}"
                                      IsEnabled="{Binding !IsProcessing}"
                                      FontWeight="SemiBold"/>
                            <TextBlock Text="(Recommended - tracked by DiffusionNexus)"
                                       Classes="SubText"
                                       VerticalAlignment="Center"
                                       Foreground="#4ade80"/>
                        </StackPanel>
                        <TextBlock Text="Creates a new version in the selected dataset with the processed images."
                                   Classes="SubText"
                                   Margin="28,0,0,0"/>
                    </StackPanel>

                    <!-- OR Separator (only when dataset is selected) -->
                    <Grid ColumnDefinitions="*,Auto,*" Margin="0,8" IsVisible="{Binding CanIncrementVersion}">
                        <Separator Grid.Column="0" VerticalAlignment="Center" Opacity="0.3"/>
                        <TextBlock Grid.Column="1" Text="OR" Margin="16,0" Opacity="0.6" FontWeight="SemiBold"/>
                        <Separator Grid.Column="2" VerticalAlignment="Center" Opacity="0.3"/>
                    </Grid>

                    <!-- Target Folder Selection -->
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Target Folder" FontWeight="SemiBold"/>
                            <TextBlock Text="(Optional - leave empty to overwrite originals)"
                                       Classes="SubText"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                        <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                            <TextBox Grid.Column="0"
                                     Text="{Binding TargetFolder}"
                                     Watermark="Same as source folder"
                                     IsEnabled="{Binding !IsProcessing}"/>
                            <Button Grid.Column="1"
                                    x:Name="BrowseTargetButton"
                                    Content="Browse..."
                                    IsEnabled="{Binding !IsProcessing}"/>
                            <Button Grid.Column="2"
                                    Content="Clear"
                                    Command="{Binding ClearTargetFolderCommand}"
                                    IsEnabled="{Binding !IsProcessing}"/>
                        </Grid>

                        <!-- Warning for external folder -->
                        <Border Background="#443322"
                                CornerRadius="6"
                                Padding="12"
                                Margin="0,8,0,0"
                                IsVisible="{Binding TargetFolder, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                            <StackPanel Spacing="4">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <Border Background="#fbbf24" CornerRadius="3" Padding="4,1" VerticalAlignment="Center">
                                        <TextBlock Text="!" FontSize="10" FontWeight="Bold" Foreground="#000"/>
                                    </Border>
                                    <TextBlock Text="External Folder"
                                               FontWeight="SemiBold"
                                               Foreground="#fbbf24"/>
                                </StackPanel>
                                <TextBlock Text="Files saved to this folder will not be tracked by DiffusionNexus. Consider using 'Create New Version' if working with a dataset."
                                           TextWrapping="Wrap"
                                           Opacity="0.9"
                                           FontSize="12"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- Overwrite Confirmation -->
                    <Border Background="#442222"
                            CornerRadius="6"
                            Padding="12"
                            IsVisible="{Binding IsOverwriteMode}">
                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Border Background="#ff6666" CornerRadius="3" Padding="4,1" VerticalAlignment="Center">
                                    <TextBlock Text="!" FontSize="10" FontWeight="Bold" Foreground="#000"/>
                                </Border>
                                <TextBlock Text="Warning: Overwrite Mode"
                                           FontWeight="SemiBold"
                                           Foreground="#ff6666"/>
                            </StackPanel>
                            <TextBlock Text="Images will be overwritten in place. This cannot be undone!"
                                       TextWrapping="Wrap"
                                       Opacity="0.9"/>
                            <CheckBox Content="I understand and want to overwrite original files"
                                      IsChecked="{Binding OverwriteConfirmed}"
                                      IsEnabled="{Binding !IsProcessing}"/>
                        </StackPanel>
                    </Border>

                    <CheckBox Content="Skip copying unchanged files"
                              IsChecked="{Binding SkipUnchanged}"
                              IsEnabled="{Binding !IsProcessing}"
                              IsVisible="{Binding !IsOverwriteMode}"/>
                </StackPanel>
            </Border>

            <!-- Progress Card (visible during processing) -->
            <Border Classes="Card" IsVisible="{Binding IsProcessing}">
                <StackPanel Spacing="12">
                    <TextBlock Text="Processing..." Classes="Header"/>
                    <ProgressBar Value="{Binding ProgressPercentage}"
                                 Maximum="100"
                                 Height="8"/>
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="{Binding CurrentFile}" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Grid.Column="1" Text="{Binding CurrentBucket}"/>
                    </Grid>
                    <Grid ColumnDefinitions="*,*,*,*">
                        <StackPanel>
                            <TextBlock Text="Processed" Classes="SubText"/>
                            <TextBlock Text="{Binding ProcessedCount}" FontSize="18"/>
                        </StackPanel>
                        <StackPanel Grid.Column="1">
                            <TextBlock Text="Success" Classes="SubText"/>
                            <TextBlock Text="{Binding SuccessCount}" FontSize="18" Foreground="#4ade80"/>
                        </StackPanel>
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Skipped" Classes="SubText"/>
                            <TextBlock Text="{Binding SkippedCount}" FontSize="18" Foreground="#fbbf24"/>
                        </StackPanel>
                        <StackPanel Grid.Column="3">
                            <TextBlock Text="Failed" Classes="SubText"/>
                            <TextBlock Text="{Binding FailedCount}" FontSize="18" Foreground="#f87171"/>
                        </StackPanel>
                    </Grid>
                    <TextBlock Text="{Binding ElapsedTime}" HorizontalAlignment="Right" Opacity="0.7"/>
                </StackPanel>
            </Border>

            <!-- Action Buttons -->
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Spacing="16"
                        Margin="0,16">
                <Button Classes="primary-btn"
                        Content="Start Processing"
                        Command="{Binding StartCommand}"
                        IsVisible="{Binding !IsProcessing}"/>
                <Button Content="Cancel"
                        Command="{Binding CancelCommand}"
                        IsVisible="{Binding IsProcessing}"
                        Padding="32,12"/>
                <Button Content="Refresh"
                        Command="{Binding RefreshCommand}"
                        IsVisible="{Binding !IsProcessing}"
                        Padding="24,12"/>
            </StackPanel>

            <!-- Status Message -->
            <TextBlock Text="{Binding StatusMessage}"
                       HorizontalAlignment="Center"
                       Opacity="0.8"
                       Margin="0,8"/>

        </StackPanel>
    </ScrollViewer>
</UserControl>
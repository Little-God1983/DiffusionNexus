<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:DiffusionNexus.UI.ViewModels"
             xmlns:converters="using:DiffusionNexus.UI.Converters"
             xmlns:controls="using:DiffusionNexus.UI.Controls"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="DiffusionNexus.UI.Views.LoraDatasetHelperView"
             x:DataType="vm:LoraDatasetHelperViewModel">

  <UserControl.Resources>
    <converters:PathToBitmapConverter x:Key="PathToBitmapConverter"/>
  </UserControl.Resources>

  <Design.DataContext>
    <vm:LoraDatasetHelperViewModel/>
  </Design.DataContext>

  <Grid RowDefinitions="*,Auto">
    <TabControl Grid.Row="0" SelectedIndex="{Binding SelectedTabIndex}">
      
      <!-- Dataset Management Tab -->
      <TabItem Header="Dataset Management">
        <Grid RowDefinitions="Auto,*">
          
          <!-- Toolbar -->
          <Border Grid.Row="0" 
                  Background="#1E1E1E" 
                  Padding="16,12"
                  BorderBrush="#333"
                  BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,*,Auto,Auto,Auto,Auto,Auto,Auto,Auto">
              
              <!-- Back to Overview Button (only visible when viewing a dataset) -->
              <Button Grid.Column="0"
                      Content="← Overview"
                      Command="{Binding GoToOverviewCommand}"
                      IsVisible="{Binding IsViewingDataset}"
                      Margin="0,0,16,0"/>
              
              <!-- Dataset Title (when viewing) -->
              <StackPanel Grid.Column="1"
                          Orientation="Horizontal"
                          Spacing="12"
                          VerticalAlignment="Center"
                          IsVisible="{Binding IsViewingDataset}">
                <TextBlock Text="{Binding ActiveDataset.Name}"
                           FontSize="18"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"/>
                <!-- Editable Description for current version -->
                <TextBox Text="{Binding ActiveDataset.Description, Mode=TwoWay}"
                         x:Name="DescriptionTextBox"
                         Watermark="Add description..."
                         FontSize="12"
                         MinWidth="200"
                         MaxWidth="350"
                         Padding="6,4"
                         Background="#333"
                         BorderBrush="#444"
                         BorderThickness="1"
                         CornerRadius="4"
                         VerticalAlignment="Center"/>
              </StackPanel>
              
              <!-- Version Dropdown (when viewing dataset with multiple versions) -->
              <StackPanel Grid.Column="2"
                          Orientation="Horizontal"
                          Spacing="6"
                          Margin="8,0,0,0"
                          IsVisible="{Binding IsViewingDataset}"
                          VerticalAlignment="Center">
                <TextBlock Text="Version:"
                           VerticalAlignment="Center"
                           Opacity="0.7"
                           IsVisible="{Binding ActiveDataset.HasMultipleVersions}"/>
                <ComboBox ItemsSource="{Binding AvailableVersions}"
                          SelectedItem="{Binding SelectedVersion, Mode=TwoWay}"
                          MinWidth="70"
                          IsVisible="{Binding ActiveDataset.HasMultipleVersions}">
                  <ComboBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding StringFormat='V{0}'}"
                                 Foreground="#4CAF50"/>
                    </DataTemplate>
                  </ComboBox.ItemTemplate>
                </ComboBox>
                <!-- Single version display (when only one version exists) -->
                <Border Background="#333"
                        CornerRadius="4"
                        Padding="8,4"
                        IsVisible="{Binding !ActiveDataset.HasMultipleVersions}">
                  <TextBlock Text="V1"
                             FontSize="12"
                             Foreground="#4CAF50"
                             VerticalAlignment="Center"/>
                </Border>
              </StackPanel>
              
              <!-- Category Dropdown (when viewing dataset) -->
              <StackPanel Grid.Column="3" 
                          Orientation="Horizontal" 
                          Spacing="8"
                          IsVisible="{Binding IsViewingDataset}"
                          Margin="16,0,0,0">
                <TextBlock Text="Category:"
                           VerticalAlignment="Center"
                           Opacity="0.7"/>
                <ComboBox ItemsSource="{Binding AvailableCategories}"
                          SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                          DisplayMemberBinding="{Binding Name}"
                          MinWidth="120"
                          PlaceholderText="Select category..."/>
              </StackPanel>
              
              <!-- Type Dropdown (when viewing dataset) -->
              <StackPanel Grid.Column="4"
                          Orientation="Horizontal"
                          Spacing="8"
                          IsVisible="{Binding IsViewingDataset}"
                          Margin="8,0,0,0">
                <TextBlock Text="Type:"
                           VerticalAlignment="Center"
                           Opacity="0.7"/>
                <ComboBox ItemsSource="{Binding AvailableTypes}"
                          SelectedItem="{Binding SelectedType, Mode=TwoWay}"
                          MinWidth="100"
                          PlaceholderText="Select type...">
                  <ComboBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Converter={x:Static converters:DatasetTypeDisplayConverter.Instance}}"/>
                    </DataTemplate>
                  </ComboBox.ItemTemplate>
                </ComboBox>
              </StackPanel>
              
              <!-- Flatten Versions Toggle (only in overview) -->
              <StackPanel Grid.Column="5"
                          Orientation="Horizontal"
                          Spacing="8"
                          IsVisible="{Binding !IsViewingDataset}"
                          VerticalAlignment="Center">
                <ToggleSwitch IsChecked="{Binding FlattenVersions, Mode=TwoWay}"
                              OnContent="Flatten Versions"
                              OffContent="Flatten Versions"
                              ToolTip.Tip="Show individual cards for each version folder"/>
              </StackPanel>
              
              <!-- Spacer -->
              <Border Grid.Column="6"/>
              
              <!-- Open Folder Button (when viewing dataset) -->
              <Button Grid.Column="7"
                      Content="📂 Open Folder"
                      Command="{Binding OpenContainingFolderCommand}"
                      IsVisible="{Binding IsViewingDataset}"
                      Margin="0,0,8,0"
                      ToolTip.Tip="Open dataset folder in file explorer"/>
              
              <!-- Export Dataset Button (when viewing dataset) -->
              <Button Grid.Column="8"
                      Content="📦 Export Dataset"
                      Command="{Binding ExportDatasetCommand}"
                      IsVisible="{Binding IsViewingDataset}"
                      Margin="0,0,8,0"
                      ToolTip.Tip="Export dataset for training"/>
              
              <!-- Add Images Button (when viewing dataset) -->
              <Button Grid.Column="9"
                      Content="+ Add Files"
                      Command="{Binding AddImagesCommand}"
                      IsVisible="{Binding IsViewingDataset}"
                      Margin="0,0,8,0"/>
              
              <!-- Increment Version Button (when viewing dataset with images) -->
              <Button Grid.Column="10"
                      Content="📋 New Version"
                      Command="{Binding IncrementVersionCommand}"
                      IsVisible="{Binding IsViewingDataset}"
                      IsEnabled="{Binding ActiveDataset.CanIncrementVersion}"
                      Margin="0,0,8,0"
                      ToolTip.Tip="Create a new version by copying all images and captions. Use for different captioning styles (e.g., SDXL vs Flux)."/>
              
              <!-- Save Captions Button (when viewing dataset with changes) -->
              <Button Grid.Column="11"
                      Content="Save Captions"
                      Command="{Binding SaveAllCaptionsCommand}"
                      IsVisible="{Binding HasUnsavedChanges}"
                      Margin="0,0,8,0"
                      Background="#2D7D46"/>
              
              <!-- New Dataset Button (only in overview) -->
              <Button Grid.Column="13"
                      Content="+ New Dataset" 
                      Command="{Binding CreateDatasetCommand}"
                      IsVisible="{Binding !IsViewingDataset}"/>
              
            </Grid>
          </Border>

          <!-- Content Area -->
          <Grid Grid.Row="1">
            
            <!-- Loading Overlay -->
            <Border IsVisible="{Binding IsLoading}"
                    Background="#80000000"
                    ZIndex="100">
              <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200"/>
                <TextBlock Text="Loading..." 
                           Foreground="White"
                           HorizontalAlignment="Center"
                           Margin="0,8,0,0"/>
              </StackPanel>
            </Border>
            
            <!-- Configuration Warning -->
            <Border IsVisible="{Binding !IsStorageConfigured}"
                    Background="#1A1A1A"
                    CornerRadius="8"
                    Margin="16"
                    Padding="32"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
              <StackPanel Spacing="16" HorizontalAlignment="Center">
                <TextBlock Text="⚠️" FontSize="64" HorizontalAlignment="Center" Opacity="0.3"/>
                <TextBlock Text="Dataset Storage Not Configured" 
                           FontSize="20" 
                           FontWeight="SemiBold"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="Please configure the Dataset Storage Path in Settings before creating datasets."
                           Opacity="0.6"
                           HorizontalAlignment="Center"
                           TextWrapping="Wrap"
                           MaxWidth="400"/>
              </StackPanel>
            </Border>

            <!-- Dataset Overview (Grouped by Category with separator lines) -->
            <ScrollViewer IsVisible="{Binding !IsViewingDataset}"
                          Padding="16">
              <ItemsControl ItemsSource="{Binding GroupedDatasets}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <StackPanel Orientation="Vertical" Spacing="8"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="vm:DatasetGroupViewModel">
                    <!-- Category Group Section -->
                    <StackPanel Spacing="8">
                      
                      <!-- Category Header with Separator Line -->
                      <Grid ColumnDefinitions="Auto,8,*,8,Auto" Margin="8,8,8,4">
                        <!-- Category Name -->
                        <TextBlock Grid.Column="0"
                                   Text="{Binding Name}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="#888"
                                   VerticalAlignment="Center"/>
                        
                        <!-- Separator Line -->
                        <Border Grid.Column="2"
                                Height="1"
                                Background="#444"
                                VerticalAlignment="Center"/>
                        
                        <!-- Dataset Count -->
                        <TextBlock Grid.Column="4"
                                   Text="{Binding DatasetCountText}"
                                   FontSize="12"
                                   Foreground="#666"
                                   VerticalAlignment="Center"/>
                      </Grid>
                      
                      <!-- Datasets in this category -->
                      <ItemsControl ItemsSource="{Binding Datasets}">
                        <ItemsControl.ItemsPanel>
                          <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"/>
                          </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                          <DataTemplate x:DataType="vm:DatasetCardViewModel">
                            <Button Command="{Binding $parent[ScrollViewer].((vm:LoraDatasetHelperViewModel)DataContext).OpenDatasetCommand}"
                                    CommandParameter="{Binding}"
                                    Margin="8"
                                    Padding="0"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Cursor="Hand">
                              <Border Width="200" 
                                      Height="240"
                                      Background="#2A2A2A"
                                      CornerRadius="8"
                                      ClipToBounds="True"
                                      BorderBrush="#444"
                                      BorderThickness="1">
                                <Grid RowDefinitions="*,Auto">
                                  
                                  <!-- Thumbnail Area -->
                                  <Border Grid.Row="0" 
                                          Background="#1A1A1A"
                                          CornerRadius="8,8,0,0"
                                          ClipToBounds="True">
                                    <Grid>
                                      <!-- Placeholder when no thumbnail -->
                                      <TextBlock Text="📁" 
                                                 FontSize="64" 
                                                 Opacity="0.2"
                                                 HorizontalAlignment="Center"
                                                 VerticalAlignment="Center"
                                                 IsVisible="{Binding !HasThumbnail}"/>
                                      
                                      <!-- Thumbnail image using converter -->
                                      <Image Source="{Binding ThumbnailPath, Converter={StaticResource PathToBitmapConverter}}"
                                             Stretch="UniformToFill"
                                             IsVisible="{Binding HasThumbnail}"/>
                                      
                                      <!-- Version Badge (top-left) -->
                                      <Border Background="#4CAF50"
                                              CornerRadius="4"
                                              Padding="6,3"
                                              HorizontalAlignment="Left"
                                              VerticalAlignment="Top"
                                              Margin="8"
                                              IsVisible="{Binding ShowVersionBadge}">
                                        <TextBlock Text="{Binding VersionBadgeText}"
                                                   FontSize="11"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"/>
                                      </Border>
                                      
                                      <!-- Delete button overlay -->
                                      <Button Content="🗑️"
                                              Command="{Binding $parent[ScrollViewer].((vm:LoraDatasetHelperViewModel)DataContext).DeleteDatasetCommand}"
                                              CommandParameter="{Binding}"
                                              HorizontalAlignment="Right"
                                              VerticalAlignment="Top"
                                              Margin="8"
                                              Padding="6"
                                              Background="#80000000"
                                              CornerRadius="4"
                                              Opacity="0.7"/>
                                    </Grid>
                                  </Border>
                                  
                                  <!-- Info Area -->
                                  <Border Grid.Row="1" 
                                          Padding="12,8"
                                          Background="#2A2A2A">
                                    <StackPanel>
                                      <TextBlock Text="{Binding Name}"
                                                 FontWeight="SemiBold"
                                                 FontSize="14"
                                                 TextTrimming="CharacterEllipsis"
                                                 MaxLines="1"/>
                                      <!-- Description (if available) -->
                                      <TextBlock Text="{Binding Description}"
                                                 FontSize="11"
                                                 Opacity="0.7"
                                                 TextTrimming="CharacterEllipsis"
                                                 MaxLines="1"
                                                 IsVisible="{Binding HasDescription}"
                                                 Margin="0,2,0,0"/>
                                      <TextBlock Text="{Binding ImageCountText}"
                                                 FontSize="12"
                                                 Opacity="0.6"/>
                                    </StackPanel>
                                  </Border>
                                  
                                </Grid>
                              </Border>
                            </Button>
                          </DataTemplate>
                        </ItemsControl.ItemTemplate>
                      </ItemsControl>
                      
                    </StackPanel>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>

            <!-- Dataset Detail View (Images with Captions) -->
            <Grid IsVisible="{Binding IsViewingDataset}">
              <!-- Empty Dataset Drop Zone - Full area background -->
              <Border x:Name="EmptyDatasetDropZone"
                      IsVisible="{Binding HasNoImages}"
                      Background="#1A1A1A"
                      BorderThickness="3"
                      BorderBrush="#444"
                      Margin="16"
                      CornerRadius="12"
                      DragDrop.AllowDrop="True">
                <StackPanel VerticalAlignment="Center" 
                            HorizontalAlignment="Center"
                            Spacing="16">
                  <TextBlock Text="📁" 
                             FontSize="72" 
                             HorizontalAlignment="Center"
                             Opacity="0.4"/>
                  <TextBlock Text="This dataset is empty"
                             FontSize="20"
                             FontWeight="SemiBold"
                             HorizontalAlignment="Center"
                             Opacity="0.8"/>
                  <TextBlock Text="Drag and drop images or videos here to get started"
                             FontSize="14"
                             Foreground="#888"
                             HorizontalAlignment="Center"/>
                  <TextBlock Text="or"
                             FontSize="12"
                             Foreground="#666"
                             HorizontalAlignment="Center"
                             Margin="0,8"/>
                  <Button Content="📂 Browse for Files"
                          Command="{Binding AddImagesCommand}"
                          HorizontalAlignment="Center"
                          Padding="16,10"
                          FontSize="14"/>
                  <TextBlock Text="Supported: PNG, JPG, WebP, GIF, MP4, MOV, WebM, AVI, MKV"
                             FontSize="11"
                             Foreground="#666"
                             HorizontalAlignment="Center"
                             Margin="0,8,0,0"/>
                </StackPanel>
              </Border>
              
              <!-- Image Cards (when there are images) -->
              <Grid IsVisible="{Binding !HasNoImages}" RowDefinitions="Auto,*">
                
                <!-- Selection Toolbar (shown when items are selected) -->
                <Border Grid.Row="0"
                        Background="#1E1E1E"
                        Padding="12,8"
                        BorderBrush="#333"
                        BorderThickness="0,0,0,1"
                        IsVisible="{Binding HasSelection}">
                  <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,*,Auto,Auto,Auto,Auto,Auto,Auto">
                    
                    <!-- Selection Count -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                      <Border Background="#4CAF50" CornerRadius="4" Padding="8,4">
                        <TextBlock Text="{Binding SelectionText}"
                                   FontWeight="SemiBold"
                                   Foreground="White"/>
                      </Border>
                    </StackPanel>
                    
                    <!-- Select All / Clear Selection -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="16,0,0,0">
                      <Button Content="Select All"
                              Command="{Binding SelectAllCommand}"
                              Padding="8,4"
                              ToolTip.Tip="Select all items (Ctrl+A)"/>
                      <Button Content="Clear Selection"
                              Command="{Binding ClearSelectionCommand}"
                              Padding="8,4"
                              ToolTip.Tip="Clear all selections (Escape)"/>
                    </StackPanel>
                    
                    <!-- Separator -->
                    <Border Grid.Column="2" Width="1" Background="#444" Margin="12,4"/>
                    
                    <!-- Quick Select by Rating -->
                    <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="4">
                      <TextBlock Text="Quick Select:"
                                 VerticalAlignment="Center"
                                 Opacity="0.7"
                                 Margin="0,0,4,0"/>
                      <Button Content="✓ Ready"
                              Command="{Binding SelectApprovedCommand}"
                              Padding="8,4"
                              Background="#2D7D46"
                              ToolTip.Tip="Select all production-ready items"/>
                      <Button Content="✗ Failed"
                              Command="{Binding SelectRejectedCommand}"
                              Padding="8,4"
                              Background="#D9534F"
                              ToolTip.Tip="Select all failed/rejected items"/>
                    </StackPanel>
                    
                    <!-- Spacer -->
                    <Border Grid.Column="4"/>
                    
                    <!-- Bulk Actions -->
                    <TextBlock Grid.Column="5" 
                               Text="Bulk Actions:"
                               VerticalAlignment="Center"
                               Opacity="0.7"
                               Margin="0,0,8,0"/>
                    
                    <Button Grid.Column="6"
                            Content="▲ Mark Ready"
                            Command="{Binding ApproveSelectedCommand}"
                            Background="#2D7D46"
                            Padding="12,6"
                            Margin="0,0,4,0"
                            ToolTip.Tip="Mark selected items as production-ready"/>
                    
                    <Button Grid.Column="7"
                            Content="▼ Mark Failed"
                            Command="{Binding RejectSelectedCommand}"
                            Background="#D9534F"
                            Padding="12,6"
                            Margin="0,0,4,0"
                            ToolTip.Tip="Mark selected items as failed/rejected"/>
                    
                    <Button Grid.Column="8"
                            Content="Clear Rating"
                            Command="{Binding ClearRatingSelectedCommand}"
                            Padding="12,6"
                            Margin="0,0,4,0"
                            ToolTip.Tip="Clear rating for selected items"/>
                    
                    <!-- Separator -->
                    <Border Grid.Column="9" Width="1" Background="#444" Margin="8,4"/>
                    
                    <!-- Delete Selected -->
                    <Button Grid.Column="10"
                            Content="🗑️ Delete Selected"
                            Command="{Binding DeleteSelectedCommand}"
                            Background="#B22222"
                            Padding="12,6"
                            ToolTip.Tip="Delete all selected items"/>
                    
                  </Grid>
                </Border>
                
                <!-- Scrollable Image Grid -->
                <ScrollViewer Grid.Row="1" Padding="16">
                  <ItemsControl ItemsSource="{Binding DatasetImages}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate x:DataType="vm:DatasetImageViewModel">
                        <Border Width="340" 
                                Margin="8"
                                Background="#2A2A2A"
                                CornerRadius="8"
                                ClipToBounds="True"
                                BorderBrush="#444"
                                BorderThickness="2"
                                PointerPressed="OnImageCardPointerPressed">
                          <Grid RowDefinitions="240,Auto,Auto,Auto">
                            
                            <!-- Selection overlay (absolute positioned, doesn't affect layout) -->
                            <Border Grid.RowSpan="4"
                                    CornerRadius="6"
                                    BorderBrush="#2196F3"
                                    BorderThickness="3"
                                    Margin="-1"
                                    IsVisible="{Binding IsSelected}"
                                    IsHitTestVisible="False"/>
                            
                            <!-- Image area -->
                            <Border Grid.Row="0" 
                                    Background="#1A1A1A"
                                    CornerRadius="6,6,0,0"
                                    ClipToBounds="True">
                              <Panel>
                                <!-- Image/Video thumbnail using converter -->
                                <Image Source="{Binding ThumbnailPath, Converter={StaticResource PathToBitmapConverter}}"
                                       Stretch="UniformToFill"/>
                                
                                <!-- Selection checkbox overlay (top-left corner) -->
                                <Border Background="#80000000"
                                        CornerRadius="4"
                                        Padding="4"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Top"
                                        Margin="8">
                                  <CheckBox IsChecked="{Binding IsSelected}"
                                            ToolTip.Tip="Click to select (Shift+Click for range, Ctrl+Click for multi)"/>
                                </Border>
                                
                                <!-- Video indicator badge (for videos) -->
                                <Border Background="#80000000"
                                        CornerRadius="4"
                                        Padding="6,3"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Bottom"
                                        Margin="8"
                                        IsVisible="{Binding IsVideo}">
                                  <TextBlock Text="🎬 Video"
                                             FontSize="12"
                                             Foreground="White"/>
                                </Border>
                                
                                <!-- Rating status indicator (top-right) -->
                                <Border Background="{Binding IsApproved, Converter={x:Static converters:BoolConverters.BoolToApprovedBackground}}"
                                        CornerRadius="4"
                                        Padding="8,4"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Top"
                                        Margin="8"
                                        IsVisible="{Binding !IsUnrated}">
                                  <TextBlock Text="{Binding IsApproved, Converter={x:Static converters:BoolConverters.BoolToApprovedText}}"
                                             FontSize="12"
                                             FontWeight="SemiBold"
                                             Foreground="White"/>
                                </Border>
                              </Panel>
                            </Border>
                            
                            <!-- Action buttons toolbar (below image, above filename) -->
                            <Border Grid.Row="1" 
                                    Background="#1A1A1A"
                                    Padding="8,6">
                              <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto">
                                <!-- Rating buttons (left) -->
                                <Button Grid.Column="0"
                                        Content="▲"
                                        Command="{Binding MarkApprovedCommand}"
                                        Padding="12,6"
                                        FontSize="14"
                                        Background="{Binding IsApproved, Converter={x:Static converters:BoolConverters.BoolToApprovedButtonBackground}}"
                                        Foreground="{Binding IsApproved, Converter={x:Static converters:BoolConverters.BoolToApprovedButtonForeground}}"
                                        CornerRadius="4"
                                        Margin="0,0,4,0"
                                        ToolTip.Tip="Mark as production-ready"/>
                                <Button Grid.Column="1"
                                        Content="▼"
                                        Command="{Binding MarkRejectedCommand}"
                                        Padding="12,6"
                                        FontSize="14"
                                        Background="{Binding IsRejected, Converter={x:Static converters:BoolConverters.BoolToRejectedButtonBackground}}"
                                        Foreground="{Binding IsRejected, Converter={x:Static converters:BoolConverters.BoolToRejectedButtonForeground}}"
                                        CornerRadius="4"
                                        ToolTip.Tip="Mark as failed/rejected"/>
                                
                                <!-- Spacer -->
                                <Border Grid.Column="2"/>
                                
                                <!-- Action buttons (right) -->
                                <Button Grid.Column="3"
                                        Content="🖼️"
                                        Command="{Binding $parent[ItemsControl].((vm:LoraDatasetHelperViewModel)DataContext).SendToImageEditCommand}"
                                        CommandParameter="{Binding}"
                                        Padding="12,6"
                                        FontSize="14"
                                        Background="#444"
                                        CornerRadius="4"
                                        Margin="0,0,4,0"
                                        ToolTip.Tip="Send to Image Edit"/>
                                <Button Grid.Column="4"
                                        Content="🗑️"
                                        Command="{Binding DeleteCommand}"
                                        Padding="12,6"
                                        FontSize="14"
                                        Background="#444"
                                        CornerRadius="4"
                                        ToolTip.Tip="Delete image"/>
                              </Grid>
                            </Border>
                            
                            <!-- Filename -->
                            <Border Grid.Row="2" 
                                    Padding="10,6"
                                    Background="#222">
                              <TextBlock Text="{Binding FullFileName}"
                                         FontSize="12"
                                         Opacity="0.7"
                                         TextTrimming="CharacterEllipsis"/>
                            </Border>
                            
                            <!-- Caption Editor -->
                            <Border Grid.Row="3" Padding="10">
                              <Grid RowDefinitions="*,Auto">
                                <TextBox Grid.Row="0"
                                         Text="{Binding Caption, Mode=TwoWay}"
                                         Watermark="Enter caption..."
                                         TextWrapping="Wrap"
                                         AcceptsReturn="True"
                                         FontSize="13"
                                         MinHeight="80"
                                         MaxHeight="120"/>
                                
                                <!-- Unsaved indicator + Save button -->
                                <StackPanel Grid.Row="1" 
                                            Orientation="Horizontal"
                                            HorizontalAlignment="Right"
                                            Margin="0,6,0,0"
                                            IsVisible="{Binding HasUnsavedChanges}">
                                  <TextBlock Text="Modified"
                                             Foreground="Orange"
                                             FontSize="12"
                                             VerticalAlignment="Center"
                                             Margin="0,0,8,0"/>
                                  <Button Content="Save"
                                          Command="{Binding SaveCaptionCommand}"
                                          FontSize="12"
                                          Padding="10,4"/>
                                </StackPanel>
                              </Grid>
                            </Border>
                            
                          </Grid>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </ScrollViewer>
              </Grid>
            </Grid>
          </Grid>
        </Grid>
      </TabItem>

      <!-- Image Edit Tab -->
      <TabItem Header="Image Edit">
        <Grid ColumnDefinitions="*,Auto">
          <Grid Grid.Column="0" RowDefinitions="Auto,*,Auto">
          
            <!-- Toolbar -->
            <Border Grid.Row="0" 
                    Background="#1E1E1E" 
                    Padding="16,12"
                    BorderBrush="#333"
                    BorderThickness="0,0,0,1">
              <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto,Auto,Auto,Auto,Auto,Auto,Auto">
                
                <!-- Image Info -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16">
                  <TextBlock Text="{Binding ImageEditor.ImageFileName, FallbackValue='No image loaded'}"
                             FontSize="16"
                             FontWeight="SemiBold"
                             VerticalAlignment="Center"
                             Opacity="{Binding ImageEditor.HasImage, Converter={x:Static converters:BoolConverters.BoolToOpacity}}"/>
                  <TextBlock Text="{Binding ImageEditor.ImageDimensions}"
                             FontSize="14"
                             VerticalAlignment="Center"
                             Opacity="0.6"
                             IsVisible="{Binding ImageEditor.HasImage}"/>
                </StackPanel>
                
                <!-- Tool Separator -->
                <Border Grid.Column="1" Width="1" Background="#444" Margin="16,4" IsVisible="{Binding ImageEditor.HasImage}"/>
                
                <!-- Tools -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" IsVisible="{Binding ImageEditor.HasImage}">
                  <!-- Crop Tool Button -->
                  <ToggleButton Content="✂️ Crop"
                                IsChecked="{Binding ImageEditor.IsCropToolActive, Mode=TwoWay}"
                                ToolTip.Tip="Crop tool (C to apply, Escape to cancel)"
                                Padding="12,6"/>
                </StackPanel>
                
                <!-- Spacer -->
                <Border Grid.Column="3"/>
                
                <!-- Crop Actions (visible when crop tool is active) -->
                <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="4" IsVisible="{Binding ImageEditor.IsCropToolActive}">
                  <Button Content="✓ Apply Crop"
                          Command="{Binding ImageEditor.ApplyCropCommand}"
                          Background="#2D7D46"
                          ToolTip.Tip="Apply crop (C or Enter)"/>
                  <Button Content="✕ Cancel"
                          Command="{Binding ImageEditor.CancelCropCommand}"
                          ToolTip.Tip="Cancel crop (Escape)"/>
                </StackPanel>
                
                <!-- Separator -->
                <Border Grid.Column="5" Width="1" Background="#444" Margin="8,4" IsVisible="{Binding ImageEditor.HasImage}"/>
                
                <!-- Save Buttons -->
                <StackPanel Grid.Column="6" Orientation="Horizontal" Spacing="4" IsVisible="{Binding ImageEditor.HasImage}">
                  <Button Content="💾 Save As New"
                          Command="{Binding ImageEditor.SaveAsNewCommand}"
                          Background="#2D7D46"
                          ToolTip.Tip="Save as a new file"/>
                  <Button Content="💾 Save"
                          Command="{Binding ImageEditor.SaveOverwriteCommand}"
                          ToolTip.Tip="Overwrite original file"/>
                </StackPanel>
                
                <!-- Separator -->
                <Border Grid.Column="7" Width="1" Background="#444" Margin="8,4" IsVisible="{Binding ImageEditor.HasImage}"/>
                
                <!-- Reset Button -->
                <Button Grid.Column="8"
                        Content="↺ Reset"
                        Command="{Binding ImageEditor.ResetImageCommand}"
                        Margin="0,0,8,0"
                        ToolTip.Tip="Reset to original image"/>
                
                <!-- Clear Button -->
                <Button Grid.Column="9"
                        Content="✕ Clear"
                        Command="{Binding ImageEditor.ClearImageCommand}"
                        ToolTip.Tip="Clear the image"/>
                
              </Grid>
            </Border>
            
            <!-- Image Editor Canvas -->
            <Border Grid.Row="1" 
                    Background="#1A1A1A"
                    Margin="16">
              <Grid>
                <!-- Placeholder when no image -->
                <StackPanel HorizontalAlignment="Center" 
                            VerticalAlignment="Center"
                            IsVisible="{Binding !ImageEditor.HasImage}">
                  <TextBlock Text="🖼️" 
                             FontSize="64" 
                             Opacity="0.2"
                             HorizontalAlignment="Center"/>
                  <TextBlock Text="No image loaded" 
                             FontSize="16"
                             Opacity="0.4"
                             HorizontalAlignment="Center"
                             Margin="0,8,0,0"/>
                  <TextBlock Text="Use 'Send to Image Edit' from Dataset Management"
                             FontSize="12"
                             Opacity="0.3"
                             HorizontalAlignment="Center"
                             Margin="0,4,0,0"/>
                </StackPanel>
                
                <!-- Image Editor Control -->
                <controls:ImageEditorControl x:Name="ImageEditorCanvas"
                                             ImagePath="{Binding ImageEditor.CurrentImagePath}"
                                             IsCropToolActive="{Binding ImageEditor.IsCropToolActive}"
                                             IsVisible="{Binding ImageEditor.HasImage}"/>
              </Grid>
            </Border>
            
            <!-- Bottom Status Bar with Zoom -->
            <Border Grid.Row="2"
                    Background="#1E1E1E"
                    Padding="8,4"
                    BorderBrush="#333"
                    BorderThickness="0,1,0,0"
                    IsVisible="{Binding ImageEditor.HasImage}">
              <Grid ColumnDefinitions="*,Auto">
                <!-- Status Message -->
                <TextBlock Grid.Column="0"
                           Text="{Binding ImageEditor.StatusMessage}" 
                           Opacity="0.8"
                           FontSize="12"
                           VerticalAlignment="Center"
                           IsVisible="{Binding ImageEditor.StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                
                <!-- Zoom Controls -->
                <StackPanel Grid.Column="1" 
                            Orientation="Horizontal" 
                            Spacing="4"
                            IsVisible="{Binding ImageEditor.HasImage}">
                  <Button Content="-"
                          Command="{Binding ImageEditor.ZoomOutCommand}"
                          Width="28" Height="28"
                          Padding="0"
                          ToolTip.Tip="Zoom out"/>
                  <Border Background="#333" 
                          CornerRadius="4" 
                          Padding="8,4"
                          MinWidth="50">
                    <TextBlock Text="{Binding ImageEditor.ZoomPercentageText}"
                               HorizontalAlignment="Center"
                               FontSize="12"
                               Foreground="#4CAF50"/>
                  </Border>
                  <Button Content="+"
                          Command="{Binding ImageEditor.ZoomInCommand}"
                          Width="28" Height="28"
                          Padding="0"
                          ToolTip.Tip="Zoom in"/>
                  <Button Content="Fit"
                          Command="{Binding ImageEditor.ZoomToFitCommand}"
                          Padding="8,4"
                          ToolTip.Tip="Fit to window"/>
                  <Button Content="100%"
                          Command="{Binding ImageEditor.ZoomToActualCommand}"
                          Padding="8,4"
                          ToolTip.Tip="Actual size"/>
                </StackPanel>
              </Grid>
            </Border>
            
          </Grid>
          
          <!-- Right Side Panel - Info -->
          <Border Grid.Column="1"
                  Width="200"
                  Background="#1E1E1E"
                  BorderBrush="#333"
                  BorderThickness="1,0,0,0"
                  IsVisible="{Binding ImageEditor.HasImage}">
            <ScrollViewer>
              <StackPanel Margin="12" Spacing="16">
                
                <!-- Information Section -->
                <StackPanel Spacing="8">
                  <TextBlock Text="Information"
                             FontWeight="SemiBold"
                             FontSize="14"/>
                  <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
                    <StackPanel Spacing="4">
                      <TextBlock FontSize="12" Opacity="0.8">
                        <Run Text="Size: "/>
                        <Run Text="{Binding ImageEditor.ImageWidth}"/>
                        <Run Text=" × "/>
                        <Run Text="{Binding ImageEditor.ImageHeight}"/>
                        <Run Text=" px"/>
                      </TextBlock>
                      <TextBlock Text="{Binding ImageEditor.ImageDpi, StringFormat='Resolution: {0} DPI'}"
                                 FontSize="12"
                                 Opacity="0.8"/>
                      <TextBlock Text="{Binding ImageEditor.FileSizeText, StringFormat='File: {0}'}"
                                 FontSize="12"
                                 Opacity="0.8"/>
                    </StackPanel>
                  </Border>
                </StackPanel>
                
                <!-- Zoom Section -->
                <StackPanel Spacing="8">
                  <TextBlock Text="Zoom"
                             FontWeight="SemiBold"
                             FontSize="14"/>
                  <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
                    <StackPanel Spacing="8">
                      <TextBlock Text="{Binding ImageEditor.ZoomPercentageText}"
                                 FontSize="18"
                                 FontWeight="SemiBold"
                                 Foreground="#4CAF50"
                                 HorizontalAlignment="Center"/>
                      <Slider Minimum="10" 
                              Maximum="500"
                              Value="{Binding ImageEditor.ZoomPercentage}"
                              x:Name="ZoomSlider"/>
                      <Grid ColumnDefinitions="*,*">
                        <Button Grid.Column="0"
                                Content="Fit"
                                Command="{Binding ImageEditor.ZoomToFitCommand}"
                                HorizontalAlignment="Stretch"
                                Margin="0,0,2,0"/>
                        <Button Grid.Column="1"
                                Content="100%"
                                Command="{Binding ImageEditor.ZoomToActualCommand}"
                                HorizontalAlignment="Stretch"
                                Margin="2,0,0,0"/>
                      </Grid>
                    </StackPanel>
                  </Border>
                </StackPanel>
                
              </StackPanel>
            </ScrollViewer>
          </Border>
          
        </Grid>
      </TabItem>

      <!-- Captioning Tab -->
      <TabItem Header="Captioning">
        <Grid>
          <TextBlock Text="Captioning"
                     HorizontalAlignment="Center"
                     VerticalAlignment="Center"
                     FontSize="24"
                     Opacity="0.5"/>
        </Grid>
      </TabItem>

      <!-- Auto Scale/Crop Tab -->
      <TabItem Header="Auto Scale/Crop">
        <Grid>
          <TextBlock Text="Auto Scale/Crop"
                     HorizontalAlignment="Center"
                     VerticalAlignment="Center"
                     FontSize="24"
                     Opacity="0.5"/>
        </Grid>
      </TabItem>

    </TabControl>

    <!-- Status Bar -->
    <Border Grid.Row="1"
            Background="#1E1E1E"
            Padding="8,4"
            BorderBrush="#333"
            BorderThickness="0,1,0,0"
            IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
      <TextBlock Text="{Binding StatusMessage}" 
                 Opacity="0.8"
                 FontSize="12"/>
    </Border>
  </Grid>
</UserControl>

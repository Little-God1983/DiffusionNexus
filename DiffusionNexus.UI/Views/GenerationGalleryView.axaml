<UserControl xmlns="https://github.com/avaloniaui"
           xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
           xmlns:vm="using:DiffusionNexus.UI.ViewModels"
           xmlns:converters="using:DiffusionNexus.UI.Converters"
           x:Class="DiffusionNexus.UI.Views.GenerationGalleryView"
           x:DataType="vm:GenerationGalleryViewModel">
<Design.DataContext>
    <vm:GenerationGalleryViewModel/>
  </Design.DataContext>

  <UserControl.Resources>
    <converters:PathToBitmapConverter x:Key="PathToBitmapConverter"/>
    <DataTemplate x:Key="MediaItemTemplate" x:DataType="vm:GenerationGalleryMediaItemViewModel">
      <Border Width="{Binding $parent[ScrollViewer].((vm:GenerationGalleryViewModel)DataContext).TileWidth}"
              Height="{Binding $parent[ScrollViewer].((vm:GenerationGalleryViewModel)DataContext).TileWidth}"
              Background="#2A2A2A"
              CornerRadius="8"
              ClipToBounds="True"
              Margin="6"
              BorderBrush="#444"
              BorderThickness="2"
              PointerPressed="OnMediaCardPointerPressed"
              DoubleTapped="OnMediaDoubleTapped"
              Cursor="Hand">
        <Grid>
          <!-- Selection overlay border -->
          <Border CornerRadius="6" 
                  BorderBrush="#2196F3" 
                  BorderThickness="3" 
                  Margin="-1"
                  IsVisible="{Binding IsSelected}" 
                  IsHitTestVisible="False"
                  ZIndex="10"/>

          <!-- Loading placeholder shown while thumbnail is null -->
          <Border Background="#333"
                  IsVisible="{Binding Thumbnail, Converter={x:Static ObjectConverters.IsNull}}">
            <TextBlock Text="â³" FontSize="24" Opacity="0.4"
                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
          </Border>
          <Image Source="{Binding Thumbnail, TargetNullValue={x:Null}}"
                 Stretch="UniformToFill"
                 IsVisible="{Binding IsImage}"/>
          <Border Background="Black" IsVisible="{Binding IsVideo}">
            <TextBlock Text="VIDEO" Foreground="White" FontWeight="Bold"
                       HorizontalAlignment="Center" VerticalAlignment="Center" Opacity="0.7"/>
          </Border>

          <!-- File Extension Label (Top Left) -->
          <Border Background="#66000000" CornerRadius="4" Padding="6,2"
                  HorizontalAlignment="Left" VerticalAlignment="Top" Margin="6" ZIndex="5">
            <TextBlock Text="{Binding FileExtension}" Foreground="White" FontSize="11" FontWeight="SemiBold"/>
          </Border>

          <!-- Delete Button (Top Right) -->
          <Button Content="X"
                  Command="{Binding $parent[ScrollViewer].((vm:GenerationGalleryViewModel)DataContext).DeleteImageCommand}"
                  CommandParameter="{Binding}"
                  HorizontalAlignment="Right"
                  VerticalAlignment="Top"
                  Margin="6"
                  Padding="6,2"
                  Background="#80000000"
                  CornerRadius="4"
                  Foreground="#FF6B6B"
                  FontWeight="Bold"
                  ZIndex="5"/>

          <Border Background="#CC1A1A1A" VerticalAlignment="Bottom" Padding="8,6">
            <TextBlock Text="{Binding FullFileName}" FontSize="12" Opacity="0.8"
                       TextTrimming="CharacterEllipsis" MaxLines="1"/>
          </Border>
        </Grid>
      </Border>
    </DataTemplate>
  </UserControl.Resources>

  <Grid RowDefinitions="Auto,Auto,*" Background="#252526">
    <Border Background="#1E1E1E" Padding="16" BorderBrush="#333" BorderThickness="0,0,0,1">
      <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
        <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
          <TextBlock Text="Generation Gallery" FontSize="18" FontWeight="SemiBold"/>
        </StackPanel>

        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <TextBlock Text="Sort by" VerticalAlignment="Center"/>
            <ComboBox ItemsSource="{Binding SortOptions}"
                      SelectedItem="{Binding SelectedSortOption}"
                      Width="170"/>
          </StackPanel>

          <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <TextBlock Text="Group by" VerticalAlignment="Center"/>
            <ComboBox ItemsSource="{Binding GroupingOptions}"
                      SelectedItem="{Binding SelectedGroupingOption}"
                      Width="160"/>
          </StackPanel>

          <CheckBox Content="Include sub-folders"
                    IsChecked="{Binding IncludeSubFolders}"
                    VerticalAlignment="Center"/>

          <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <TextBlock Text="Tile width" VerticalAlignment="Center"/>
            <Slider Minimum="140" Maximum="360" Value="{Binding TileWidth, Mode=TwoWay}" Width="180"/>
            <TextBlock Text="{Binding TileWidth, StringFormat='{}{0:0}px'}" VerticalAlignment="Center"/>
          </StackPanel>
        </StackPanel>

        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
          <Button Content="Send to Edit"
                  Command="{Binding SendSelectedToImageEditCommand}"
                  Padding="10,6"
                  IsEnabled="{Binding HasSelection}"
                  IsVisible="{Binding HasSelection}"/>
          <Button Content="Open Viewer"
                  Command="{Binding OpenViewerCommand}"
                  Padding="10,6"
                  IsEnabled="{Binding HasMedia}"/>
        </StackPanel>
      </Grid>
    </Border>

    <Border Grid.Row="1" Background="#1E1E1E" Padding="12,8" BorderBrush="#333" BorderThickness="0,0,0,1"
            IsVisible="{Binding HasSelection}">
      <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto">
        <Border Grid.Column="0" Background="#4CAF50" CornerRadius="4" Padding="8,4">
          <TextBlock Text="{Binding SelectionText}" FontWeight="SemiBold" Foreground="White"/>
        </Border>
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="8,0,0,0">
          <Button Content="Select All" Command="{Binding SelectAllCommand}" Padding="8,4"/>
          <Button Content="Clear Selection" Command="{Binding ClearSelectionCommand}" Padding="8,4"/>
        </StackPanel>
        <Border Grid.Column="2"/>
        <Button Grid.Column="3" Content="Add Selected to Dataset" Command="{Binding AddSelectedToDatasetCommand}"
                Background="#2E7D32" Padding="12,6" Margin="0,0,8,0"/>
        <Button Grid.Column="4" Content="Delete Selected" Command="{Binding DeleteSelectedCommand}"
                Background="#B22222" Padding="12,6"/>
      </Grid>
    </Border>

    <Grid Grid.Row="2">
      <Border IsVisible="{Binding IsBusy}" Background="#80000000" ZIndex="100">
        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
          <ProgressBar IsIndeterminate="True" Width="200"/>
          <TextBlock Text="{Binding BusyMessage}" Foreground="White" HorizontalAlignment="Center"/>
        </StackPanel>
      </Border>

      <Border IsVisible="{Binding HasNoMedia}"
              Background="#1A1A1A" CornerRadius="8" Margin="16" Padding="32"
              HorizontalAlignment="Center" VerticalAlignment="Center">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <TextBlock Text="ðŸ–¼ï¸" FontSize="64" HorizontalAlignment="Center" Opacity="0.4"/>
          <TextBlock Text="Generation Gallery Empty" FontSize="20" FontWeight="SemiBold" HorizontalAlignment="Center"/>
          <TextBlock Text="{Binding NoMediaMessage}" Opacity="0.6" TextAlignment="Center"/>
          <TextBlock Text="Open Settings â†’ Generation Galleries to add and enable folders." Opacity="0.6" TextAlignment="Center"/>
        </StackPanel>
      </Border>

      <ScrollViewer IsVisible="{Binding HasMedia}" Padding="16">
        <Grid>
          <ItemsControl ItemsSource="{Binding GroupedMediaItems}" IsVisible="{Binding IsGroupingEnabled}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <StackPanel Orientation="Vertical" Spacing="8"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:GenerationGalleryGroupViewModel">
                <StackPanel Spacing="8">
                  <Grid ColumnDefinitions="Auto,8,*,8,Auto" Margin="8,8,8,4">
                    <TextBlock Grid.Column="0" Text="{Binding Name}" FontSize="16" FontWeight="SemiBold" Foreground="#AAA"/>
                    <Border Grid.Column="2" Height="1" Background="#444" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="4" Text="{Binding CountText}" FontSize="14" Foreground="#888"/>
                  </Grid>
                  <ItemsControl ItemsSource="{Binding Items}" ItemTemplate="{StaticResource MediaItemTemplate}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                  </ItemsControl>
                </StackPanel>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <ItemsControl x:Name="GalleryItems"
                        ItemsSource="{Binding MediaItems}"
                        ItemTemplate="{StaticResource MediaItemTemplate}"
                        IsVisible="{Binding !IsGroupingEnabled}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <WrapPanel Orientation="Horizontal"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
          </ItemsControl>
        </Grid>
      </ScrollViewer>
    </Grid>
  </Grid>
</UserControl>

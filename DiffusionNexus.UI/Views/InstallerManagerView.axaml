<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:DiffusionNexus.UI.ViewModels"
             xmlns:svc="using:DiffusionNexus.UI.Services"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="600"
             x:Class="DiffusionNexus.UI.Views.InstallerManagerView"
             x:DataType="vm:InstallerManagerViewModel">

    <UserControl.Styles>
        <Style Selector="Button.launch-btn">
            <Setter Property="Background" Value="#0088CC"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="0,8"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.launch-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#009AE0"/>
        </Style>
        <Style Selector="Button.workloads-btn">
            <Setter Property="Background" Value="#3A3A3A"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="0,8"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.workloads-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#4A4A4A"/>
        </Style>
        <Style Selector="Button.stop-btn">
            <Setter Property="Background" Value="#DC3545"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.stop-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#E04858"/>
        </Style>
        <Style Selector="Button.restart-btn">
            <Setter Property="Background" Value="#0088CC"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.restart-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#009AE0"/>
        </Style>
        <Style Selector="Button.console-btn">
            <Setter Property="Background" Value="#17A2B8"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="0,6"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.console-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#1FC8E3"/>
        </Style>
        <Style Selector="Button.webui-btn">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#0088CC"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>
        <Style Selector="Border.update-badge">
            <Setter Property="Background" Value="#2E7D32"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.icon-btn">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Foreground" Value="#AAAAAA"/>
        </Style>
        <Style Selector="Button.icon-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#3D3D3D"/>
        </Style>
        <Style Selector="Button.add-btn">
            <Setter Property="Background" Value="#333333"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="16,10"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.add-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#444444"/>
        </Style>
        <!-- Running state card border glow -->
        <Style Selector="Border.card-running">
            <Setter Property="BorderBrush" Value="#2E7D32"/>
            <Setter Property="BorderThickness" Value="2"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,6*,4*" Margin="20,20,20,0">

        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto" Margin="0,0,0,16">
            <TextBlock Grid.Column="0"
                       Text="Installer Manager"
                       FontSize="24"
                       FontWeight="Bold"
                       VerticalAlignment="Center"/>
            <Button Grid.Column="1"
                    Classes="add-btn"
                    Command="{Binding AddExistingInstallationCommand}"
                    Margin="0,0,8,0">
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="+" FontSize="16" FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBlock Text="Add Existing" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
            <Button Grid.Column="2"
                    Classes="add-btn"
                    Command="{Binding StartNewInstallationCommand}">
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="+" FontSize="16" FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBlock Text="New Installation" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Loading indicator -->
        <StackPanel Grid.Row="1"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    IsVisible="{Binding IsLoading}">
            <ProgressBar IsIndeterminate="True" Width="200"/>
            <TextBlock Text="Loading installations..."
                       HorizontalAlignment="Center"
                       Margin="0,8,0,0"
                       Opacity="0.6"/>
        </StackPanel>

        <!-- Empty state -->
        <Border Grid.Row="1"
                Background="#2D2D30"
                CornerRadius="8"
                Padding="40"
                IsVisible="{Binding IsEmpty}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="12">
                <TextBlock Text="No Installations"
                           FontSize="20"
                           FontWeight="SemiBold"
                           HorizontalAlignment="Center"
                           Opacity="0.6"/>
                <TextBlock Text="Add an existing installation or set up a new one to get started."
                           FontSize="14"
                           HorizontalAlignment="Center"
                           Opacity="0.4"/>
            </StackPanel>
        </Border>

        <!-- Installer Cards Grid -->
        <ScrollViewer Grid.Row="1"
                      IsVisible="{Binding !IsEmpty}"
                      HorizontalScrollBarVisibility="Disabled"
                      VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding InstallerCards}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:InstallerPackageCardViewModel">
                        <!-- Single Installer Card -->
                        <Border Background="#2D2D2D"
                                CornerRadius="10"
                                BorderBrush="#3D3D3D"
                                BorderThickness="1"
                                Width="400"
                                Margin="0,0,16,16"
                                ClipToBounds="True">
                            <Grid RowDefinitions="Auto,Auto">
                                <!-- Top: image + info -->
                                <Grid Grid.Row="0" ColumnDefinitions="140,*" Margin="12,12,12,8">
                                    <!-- Installer logo -->
                                    <Border Grid.Column="0"
                                            Width="128" Height="128"
                                            Background="#22FFFFFF"
                                            CornerRadius="8"
                                            ClipToBounds="True">
                                        <Image Source="{Binding LogoImage}"
                                               Stretch="Uniform"
                                               Margin="4"/>
                                    </Border>

                                    <!-- Info panel -->
                                    <Grid Grid.Column="1" RowDefinitions="Auto,Auto,Auto,Auto,*" Margin="12,0,0,0">
                                        <!-- Name + kebab menu -->
                                        <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                            <TextBlock Grid.Column="0"
                                                       Text="{Binding Name}"
                                                       FontSize="15" FontWeight="Bold"
                                                       TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center"/>
                                            <Button Grid.Column="1"
                                                    Classes="icon-btn"
                                                    VerticalAlignment="Top">
                                                <TextBlock Text="&#x22EE;" FontSize="16"/>
                                                <Button.Flyout>
                                                    <MenuFlyout Placement="BottomEdgeAlignedRight">
                                                        <MenuItem Header="Settings"
                                                                  Command="{Binding OpenSettingsCommand}"/>
                                                        <MenuItem Header="Open Folder"
                                                                  Command="{Binding OpenFolderCommand}"/>
                                                        <MenuItem Header="Make Default"
                                                                  Command="{Binding MakeDefaultCommand}"/>
                                                        <Separator/>
                                                        <MenuItem Header="Remove"
                                                                  Command="{Binding RemoveCommand}"/>
                                                        <MenuItem Header="Delete from Disk"
                                                                  Command="{Binding DeleteFromDiskCommand}"
                                                                  Foreground="#DC3545"/>
                                                    </MenuFlyout>
                                                </Button.Flyout>
                                            </Button>
                                        </Grid>

                                        <!-- Installation Path -->
                                        <TextBlock Grid.Row="1"
                                                   Text="{Binding InstallationPath}"
                                                   FontSize="11" Opacity="0.4"
                                                   TextTrimming="CharacterEllipsis"
                                                   ToolTip.Tip="{Binding InstallationPath}"
                                                   Margin="0,2,0,4"/>

                                        <!-- Version -->
                                        <TextBlock Grid.Row="2"
                                                   Text="{Binding VersionDisplay}"
                                                   FontSize="12" Opacity="0.5"
                                                   Margin="0,2,0,8"
                                                   IsVisible="{Binding VersionDisplay, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                                        <!-- Update + Settings buttons -->
                                        <StackPanel Grid.Row="3" Orientation="Horizontal" Spacing="8">
                                            <Border Classes="update-badge"
                                                    IsVisible="{Binding IsUpdateAvailable}">
                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                    <TextBlock Text="&#x2601;" FontSize="12" Foreground="White"/>
                                                    <TextBlock Text="Update" FontSize="12" Foreground="White" FontWeight="SemiBold"/>
                                                </StackPanel>
                                            </Border>
                                            <TextBlock Text="&#x2B50;"
                                                       FontSize="16"
                                                       VerticalAlignment="Center"
                                                       ToolTip.Tip="Default for this type"
                                                       IsVisible="{Binding IsDefault}"/>
                                            <Button Classes="icon-btn"
                                                    Command="{Binding OpenSettingsCommand}"
                                                    ToolTip.Tip="Settings">
                                                <TextBlock Text="&#x2699;" FontSize="16"/>
                                            </Button>
                                        </StackPanel>

                                        <!-- Stop / Restart when running -->
                                        <StackPanel Grid.Row="4" Orientation="Horizontal" Spacing="6"
                                                    Margin="0,6,0,0"
                                                    IsVisible="{Binding ShowRunningControls}">
                                            <Button Classes="stop-btn" Command="{Binding StopCommand}">
                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                    <TextBlock Text="&#x25A0;" FontSize="10" VerticalAlignment="Center"/>
                                                    <TextBlock Text="Stop" FontSize="12" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Button>
                                            <Button Classes="restart-btn" Command="{Binding RestartCommand}">
                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                    <TextBlock Text="&#x21BB;" FontSize="14" VerticalAlignment="Center"/>
                                                    <TextBlock Text="Restart" FontSize="12" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </Grid>

                                <!-- Launch + Workloads (when not running) -->
                                <StackPanel Grid.Row="1"
                                            Spacing="4"
                                            Margin="12,4,12,4"
                                            IsVisible="{Binding ShowLaunchButton}">
                                    <Button Classes="launch-btn"
                                            Command="{Binding LaunchCommand}">
                                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                            <TextBlock Text="&#x1F680;" FontSize="14" VerticalAlignment="Center"/>
                                            <TextBlock Text="Launch" FontSize="14" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button Classes="workloads-btn"
                                            IsVisible="{Binding IsComfyUi}"
                                            Command="{Binding ShowWorkloadsCommand}">
                                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                            <TextBlock Text="&#x1F9F0;" FontSize="14" VerticalAlignment="Center"/>
                                            <TextBlock Text="Workloads" FontSize="14" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>

                                <!-- Console + Open Web UI (when running) -->
                                <StackPanel Grid.Row="1" Spacing="4" Margin="12,4,12,4"
                                            IsVisible="{Binding ShowRunningControls}">
                                    <Button Classes="console-btn" Command="{Binding ShowConsoleCommand}">
                                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                            <TextBlock Text="&#x2265;_" FontSize="13" VerticalAlignment="Center" FontFamily="Consolas,monospace"/>
                                            <TextBlock Text="Console" FontSize="13" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button Classes="webui-btn"
                                            Command="{Binding OpenWebUiCommand}"
                                            HorizontalAlignment="Center"
                                            IsVisible="{Binding DetectedWebUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <TextBlock Text="&#x2197;" FontSize="12"/>
                                            <TextBlock Text="Open Web UI"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Bottom Console Tray -->
        <Border Grid.Row="2"
                x:Name="TrayRoot"
                Background="#1B1B1B"
                BorderBrush="#2A2A2A"
                BorderThickness="1,1,1,0"
                CornerRadius="10,10,0,0"
                ClipToBounds="True"
                IsVisible="{Binding ConsoleTray.IsTrayOpen}"
                Margin="0,8,0,0">

            <Grid RowDefinitions="Auto,*">
                <!-- Tray Handle -->
                <Border x:Name="TrayHandle" Grid.Row="0" Background="#252526" CornerRadius="10,10,0,0" Padding="12,8" Cursor="Hand">
                    <DockPanel LastChildFill="False">
                        <StackPanel Orientation="Horizontal" Spacing="8" DockPanel.Dock="Left" VerticalAlignment="Center">
                            <TextBlock Text="&#x25B2;" FontSize="10" Opacity="0.6" VerticalAlignment="Center"/>
                            <TextBlock Text="Process Console" FontSize="12" FontWeight="SemiBold" Opacity="0.9" VerticalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="8" DockPanel.Dock="Right" VerticalAlignment="Center">
                            <ToggleButton IsChecked="{Binding ConsoleTray.IsPinned}" Padding="6,3" FontSize="11">
                                <TextBlock Text="&#x1F4CC; Pin"/>
                            </ToggleButton>
                        </StackPanel>
                    </DockPanel>
                </Border>

                <!-- Tab content area -->
                <Grid Grid.Row="1" RowDefinitions="Auto,Auto,*">
                    <!-- Tab strip -->
                    <Border Grid.Row="0" Background="#1E1E1E" Padding="4,4">
                        <ListBox ItemsSource="{Binding ConsoleTray.Tabs}"
                                 SelectedItem="{Binding ConsoleTray.SelectedTab}"
                                 Background="Transparent"
                                 ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                 ScrollViewer.VerticalScrollBarVisibility="Disabled">
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="2"/>
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="vm:InstallerPackageCardViewModel">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <Ellipse Width="8" Height="8"
                                                 Fill="#4CAF50"
                                                 IsVisible="{Binding IsRunning}"/>
                                        <TextBlock Text="{Binding Name}" FontSize="12"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>

                    <!-- Selected tab toolbar -->
                    <Border Grid.Row="1" Background="#252526" Padding="8,4"
                            IsVisible="{Binding ConsoleTray.SelectedTab, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <Grid ColumnDefinitions="*,Auto"
                              DataContext="{Binding ConsoleTray.SelectedTab}">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <Button Classes="stop-btn" Command="{Binding StopCommand}" Padding="8,3" FontSize="11">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="&#x25A0;" FontSize="9" VerticalAlignment="Center"/>
                                        <TextBlock Text="Stop" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button Classes="restart-btn" Command="{Binding RestartCommand}" Padding="8,3" FontSize="11">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="&#x21BB;" FontSize="12" VerticalAlignment="Center"/>
                                        <TextBlock Text="Restart" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                            <Button Grid.Column="1"
                                    Classes="webui-btn"
                                    Command="{Binding OpenWebUiCommand}"
                                    IsVisible="{Binding DetectedWebUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="&#x2197;" FontSize="12"/>
                                    <TextBlock Text="Open Web UI"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Console output for selected tab -->
                    <ListBox Grid.Row="2"
                             x:Name="ConsoleListBox"
                             ItemsSource="{Binding ConsoleTray.SelectedTab.ConsoleLines}"
                             Background="#1E1E1E"
                             ScrollViewer.HorizontalScrollBarVisibility="Auto"
                             ScrollViewer.VerticalScrollBarVisibility="Auto">
                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="svc:ConsoleOutputLine">
                                <StackPanel Orientation="Horizontal" Spacing="8" Margin="4,1">
                                    <TextBlock Text="{Binding LineNumber}"
                                               Foreground="#606060"
                                               FontSize="11"
                                               FontFamily="Consolas,Menlo,monospace"
                                               MinWidth="32"
                                               TextAlignment="Right"/>
                                    <TextBlock Text="{Binding Text}"
                                               FontSize="12"
                                               FontFamily="Consolas,Menlo,monospace"
                                               TextWrapping="NoWrap"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
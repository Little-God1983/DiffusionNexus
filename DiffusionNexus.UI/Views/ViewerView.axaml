<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:DiffusionNexus.UI.ViewModels"
             xmlns:converters="using:DiffusionNexus.UI.Converters"
             x:Class="DiffusionNexus.UI.Views.ViewerView"
             x:DataType="vm:ViewerViewModel">
  <Design.DataContext>
    <vm:ViewerViewModel/>
  </Design.DataContext>

  <UserControl.Resources>
    <converters:PathToBitmapConverter x:Key="PathToBitmapConverter"/>
  </UserControl.Resources>

  <Grid RowDefinitions="Auto,*" Background="#252526">
    <Border Background="#1E1E1E" Padding="16" BorderBrush="#333" BorderThickness="0,0,0,1">
      <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
        <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
          <TextBlock Text="Viewer" FontSize="18" FontWeight="SemiBold"/>
        </StackPanel>

        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <TextBlock Text="Sort by" VerticalAlignment="Center"/>
            <ComboBox ItemsSource="{Binding SortOptions}"
                      SelectedItem="{Binding SelectedSortOption}"
                      Width="170"/>
          </StackPanel>

          <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <TextBlock Text="Tile width" VerticalAlignment="Center"/>
            <Slider Minimum="140" Maximum="360" Value="{Binding TileWidth, Mode=TwoWay}" Width="180"/>
            <TextBlock Text="{Binding TileWidth, StringFormat='{}{0:0}px'}" VerticalAlignment="Center"/>
          </StackPanel>
        </StackPanel>

        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" VerticalAlignment="Center">
          <Border Background="#333" CornerRadius="6" Padding="8,4">
            <TextBlock Text="{Binding ImageExtensionsDisplay}" FontSize="11" Foreground="White"/>
          </Border>
          <Border Background="#333" CornerRadius="6" Padding="8,4">
            <TextBlock Text="{Binding VideoExtensionsDisplay}" FontSize="11" Foreground="White"/>
          </Border>
        </StackPanel>
      </Grid>
    </Border>

    <Grid Grid.Row="1">
      <Border IsVisible="{Binding IsBusy}" Background="#80000000" ZIndex="100">
        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
          <ProgressBar IsIndeterminate="True" Width="200"/>
          <TextBlock Text="{Binding BusyMessage}" Foreground="White" HorizontalAlignment="Center"/>
        </StackPanel>
      </Border>

      <Border IsVisible="{Binding HasNoMedia}"
              Background="#1A1A1A" CornerRadius="8" Margin="16" Padding="32"
              HorizontalAlignment="Center" VerticalAlignment="Center">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <TextBlock Text="ðŸ–¼ï¸" FontSize="64" HorizontalAlignment="Center" Opacity="0.4"/>
          <TextBlock Text="Viewer Gallery Empty" FontSize="20" FontWeight="SemiBold" HorizontalAlignment="Center"/>
          <TextBlock Text="{Binding NoMediaMessage}" Opacity="0.6" TextAlignment="Center"/>
          <TextBlock Text="Open Settings â†’ Image Galleries to add and enable folders." Opacity="0.6" TextAlignment="Center"/>
        </StackPanel>
      </Border>

      <ScrollViewer IsVisible="{Binding HasMedia}" Padding="16">
        <ItemsControl x:Name="GalleryItems" ItemsSource="{Binding MediaItems}">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <WrapPanel Orientation="Horizontal"/>
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="vm:ViewerMediaItemViewModel">
              <Border Width="{Binding $parent[ItemsControl].((vm:ViewerViewModel)DataContext).TileWidth}"
                      Height="{Binding $parent[ItemsControl].((vm:ViewerViewModel)DataContext).TileWidth}"
                      Background="#2A2A2A"
                      CornerRadius="8"
                      ClipToBounds="True"
                      Margin="6">
                <Grid>
                  <!-- Loading placeholder shown while thumbnail is null -->
                  <Border Background="#333"
                          IsVisible="{Binding Thumbnail, Converter={x:Static ObjectConverters.IsNull}}">
                    <TextBlock Text="â³" FontSize="24" Opacity="0.4"
                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                  </Border>
                  <Image Source="{Binding Thumbnail, TargetNullValue={x:Null}}"
                         Stretch="UniformToFill"
                         IsVisible="{Binding IsImage}"/>
                  <Border Background="Black" IsVisible="{Binding IsVideo}">
                    <TextBlock Text="VIDEO" Foreground="White" FontWeight="Bold"
                               HorizontalAlignment="Center" VerticalAlignment="Center" Opacity="0.7"/>
                  </Border>
                  <Border Background="#66000000" CornerRadius="4" Padding="6,2"
                          HorizontalAlignment="Right" VerticalAlignment="Top" Margin="6">
                    <TextBlock Text="{Binding FileExtension}" Foreground="White" FontSize="11" FontWeight="SemiBold"/>
                  </Border>
                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>
    </Grid>
  </Grid>
</UserControl>

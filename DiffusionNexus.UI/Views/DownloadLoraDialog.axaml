<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:DiffusionNexus.UI.ViewModels"
        xmlns:conv="using:DiffusionNexus.UI.Converters"
        x:Class="DiffusionNexus.UI.Views.DownloadLoraDialog"
        Width="520"
        Height="420"
        Title="Download LoRA from Civitai"
        CanResize="False"
        WindowStartupLocation="CenterOwner"
        x:DataType="vm:DownloadLoraDialogViewModel"
        mc:Ignorable="d">
  <Window.Resources>
    <conv:BooleanNotConverter x:Key="BooleanNotConverter" />
    <conv:StringNotNullOrEmptyConverter x:Key="StringNotNullOrEmptyConverter" />
  </Window.Resources>
  <Grid RowDefinitions="Auto,Auto,Auto,*,Auto" Margin="16" RowSpacing="12">
    <StackPanel Orientation="Vertical" Spacing="6">
      <TextBlock Text="Civitai Link" FontWeight="Bold"/>
      <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
        <TextBox Text="{Binding CivitaiUrl, UpdateSourceTrigger=PropertyChanged}"
                 Watermark="https://civitai.com/models/{id}?modelVersionId={version}"
                 IsEnabled="{Binding IsDownloading, Converter={StaticResource BooleanNotConverter}}"/>
        <Button Grid.Column="1"
                Content="Paste"
                MinWidth="70"
                IsEnabled="{Binding IsDownloading, Converter={StaticResource BooleanNotConverter}}"
                Command="{Binding PasteFromClipboardCommand}"/>
      </Grid>
      <StackPanel Spacing="2">
        <TextBlock Text="Examples:" FontStyle="Italic" />
        <TextBlock Text="https://civitai.com/models/372465?modelVersionId=914390"
                   FontSize="12"
                   Foreground="#AAA"/>
        <TextBlock Text="https://civitai.com/models/1153088/retro-ghibli-style-porco-rosso"
                   FontSize="12"
                   Foreground="#AAA"/>
        <TextBlock Text="Note: modelVersionId may be missing for single-version models."
                   FontSize="12"
                   Foreground="#AAA"/>
      </StackPanel>
    </StackPanel>

    <StackPanel Grid.Row="1" Orientation="Vertical" Spacing="6">
      <TextBlock Text="Target Folder" FontWeight="Bold"/>
      <ComboBox ItemsSource="{Binding Targets}"
                SelectedItem="{Binding SelectedTarget}"
                IsEnabled="{Binding IsDownloading, Converter={StaticResource BooleanNotConverter}}"
                PlaceholderText="Select a configured LoRA source"/>
    </StackPanel>

    <TextBlock Grid.Row="2"
               Foreground="#FFCC3333"
               TextWrapping="Wrap"
               Text="{Binding ErrorMessage}"
               IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotNullOrEmptyConverter}}"/>

    <StackPanel Grid.Row="3" Spacing="8">
      <ProgressBar Minimum="0"
                   Maximum="100"
                   Height="20"
                   Value="{Binding Progress}"
                   IsVisible="{Binding ShowProgress}"/>
      <StackPanel Orientation="Horizontal"
                  Spacing="12"
                  IsVisible="{Binding ShowProgress}">
        <TextBlock Text="{Binding ProgressText}"/>
        <TextBlock Text="{Binding SpeedText}"/>
        <TextBlock Text="{Binding EtaText}"/>
      </StackPanel>
    </StackPanel>

    <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
      <Button Content="Cancel"
              Command="{Binding CancelCommand}"/>
      <Button Content="OK"
              Command="{Binding OkCommand}"
              IsEnabled="{Binding IsOkEnabled}"
              IsDefault="True"/>
    </StackPanel>
  </Grid>
</Window>

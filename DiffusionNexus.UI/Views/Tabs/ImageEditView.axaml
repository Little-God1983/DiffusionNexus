<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:DiffusionNexus.UI.ViewModels"
             xmlns:vmTabs="using:DiffusionNexus.UI.ViewModels.Tabs"
             xmlns:converters="using:DiffusionNexus.UI.Converters"
             xmlns:controls="using:DiffusionNexus.UI.Controls"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="DiffusionNexus.UI.Views.Tabs.ImageEditView"
             x:DataType="vmTabs:ImageEditTabViewModel">

  <UserControl.Resources>
    <converters:PathToBitmapConverter x:Key="PathToBitmapConverter"/>
  </UserControl.Resources>

  <Grid ColumnDefinitions="Auto,*,Auto">
    
    <!-- Left Side Panel - Image Thumbnails (Always visible) -->
    <Border Grid.Column="0" Width="120" Background="#1E1E1E" BorderBrush="#333" BorderThickness="0,0,1,0">
      <Grid RowDefinitions="Auto,Auto,*">
        <!-- Header with image count -->
        <Border Grid.Row="0" Background="#2A2A2A" Padding="8,6" BorderBrush="#333" BorderThickness="0,0,0,1">
          <StackPanel Spacing="2">
            <TextBlock Text="{Binding FilterStatusText}" FontSize="11" Opacity="0.7" HorizontalAlignment="Center"/>
            <!-- Show hint when no dataset selected -->
            <TextBlock Text="Select Dataset" FontSize="9" Opacity="0.5" HorizontalAlignment="Center"
                       IsVisible="{Binding SelectedEditorDataset, Converter={x:Static ObjectConverters.IsNull}}"/>
          </StackPanel>
        </Border>
        
        <!-- Rating Filters -->
        <Border Grid.Row="1" Background="#252525" Padding="4" BorderBrush="#333" BorderThickness="0,0,0,1">
          <StackPanel Orientation="Horizontal" Spacing="2" HorizontalAlignment="Center">
            <ToggleButton Content="+" IsChecked="{Binding ShowReady, Mode=TwoWay}" 
                          Padding="6,2" FontSize="11" FontWeight="Bold"
                          ToolTip.Tip="Show Ready/Production images"
                          Foreground="#4CAF50"/>
            <ToggleButton Content="-" IsChecked="{Binding ShowTrash, Mode=TwoWay}" 
                          Padding="6,2" FontSize="11" FontWeight="Bold"
                          ToolTip.Tip="Show Trash/Rejected images"
                          Foreground="#F44336"/>
            <ToggleButton Content="?" IsChecked="{Binding ShowUnrated, Mode=TwoWay}" 
                          Padding="6,2" FontSize="11" FontWeight="Bold"
                          ToolTip.Tip="Show Unrated images"
                          Foreground="#808080"/>
          </StackPanel>
        </Border>
        
        <!-- Image List -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
          <ItemsControl ItemsSource="{Binding FilteredEditorImages}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate><StackPanel Orientation="Vertical"/></ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:DatasetImageViewModel">
                <Button Command="{Binding $parent[ItemsControl].((vmTabs:ImageEditTabViewModel)DataContext).LoadEditorImageCommand}"
                        CommandParameter="{Binding}" Padding="0" Margin="4" Background="Transparent" BorderThickness="0"
                        Cursor="Hand" ToolTip.Tip="{Binding FullFileName}">
                  <Button.ContextMenu>
                    <ContextMenu>
                      <MenuItem Header="Rate: Production (+)" Command="{Binding MarkApprovedCommand}"/>
                      <MenuItem Header="Rate: Trash (-)" Command="{Binding MarkRejectedCommand}"/>
                      <Separator/>
                      <MenuItem Header="Clear Rating" Command="{Binding ClearRatingCommand}"/>
                    </ContextMenu>
                  </Button.ContextMenu>
                  <Grid Width="104" Height="78">
                    <Border Background="#2A2A2A" CornerRadius="4" ClipToBounds="True"
                            BorderBrush="{Binding IsEditorSelected, Converter={x:Static converters:BoolConverters.BoolToSelectionBorder}}"
                            BorderThickness="{Binding IsEditorSelected, Converter={x:Static converters:BoolConverters.BoolToSelectionThickness}}">
                      <Image Source="{Binding Thumbnail}" Stretch="UniformToFill"/>
                    </Border>
                    <!-- Rating Badge Overlay -->
                    <Border Width="18" Height="18" CornerRadius="2"
                            HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,2,2,0"
                            Background="{Binding RatingStatus, Converter={x:Static converters:BoolConverters.RatingStatusToBackground}}"
                            IsVisible="{Binding RatingStatus, Converter={x:Static converters:BoolConverters.RatingStatusToVisibility}}">
                      <TextBlock Text="{Binding RatingStatus, Converter={x:Static converters:BoolConverters.RatingStatusToSymbol}}"
                                 Foreground="White" FontWeight="Bold" FontSize="14"
                                 HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                  </Grid>
                </Button>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </Grid>
    </Border>
    
    <!-- Main Editor Area -->
    <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto">
      <!-- Toolbar -->
      <Border Grid.Row="0" Background="#1E1E1E" Padding="16,8" BorderBrush="#333" BorderThickness="0,0,0,1">
        <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,*,Auto,Auto,Auto,Auto">
          <!-- Dataset and Version stacked vertically -->
          <StackPanel Grid.Column="0" Spacing="6" VerticalAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <TextBlock Text="Dataset:" VerticalAlignment="Center" Opacity="0.7" MinWidth="50"/>
              <ComboBox ItemsSource="{Binding EditorDatasets}" SelectedItem="{Binding SelectedEditorDataset, Mode=TwoWay}"
                        IsEditable="True" MinWidth="180" MaxWidth="250" PlaceholderText="Search datasets...">
                <ComboBox.ItemTemplate>
                  <DataTemplate x:DataType="vm:DatasetCardViewModel">
                    <TextBlock Text="{Binding Name}"/>
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="8">
              <TextBlock Text="Version:" VerticalAlignment="Center" Opacity="0.7" MinWidth="50"/>
              <ComboBox ItemsSource="{Binding EditorVersionItems}" SelectedItem="{Binding SelectedEditorVersion, Mode=TwoWay}" MinWidth="120"
                        IsEnabled="{Binding SelectedEditorDataset, Converter={x:Static ObjectConverters.IsNotNull}}">
                <ComboBox.ItemTemplate>
                  <DataTemplate x:DataType="vm:EditorVersionItem">
                    <TextBlock Text="{Binding DisplayText}" Foreground="#4CAF50"/>
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>
            </StackPanel>
          </StackPanel>
          <!-- Separator - always visible -->
          <Border Grid.Column="1" Width="1" Background="#444" Margin="16,4"/>
          <!-- Tool toggles - always visible but disabled when no image -->
          <StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="4">
            <ToggleButton Content="Crop" IsChecked="{Binding ImageEditor.IsCropToolActive, Mode=TwoWay}" Padding="12,6"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Color" IsChecked="{Binding ImageEditor.ColorTools.IsColorBalancePanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Color Balance"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="B/C" IsChecked="{Binding ImageEditor.ColorTools.IsBrightnessContrastPanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Brightness &amp; Contrast"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Rm BG" IsChecked="{Binding ImageEditor.BackgroundRemoval.IsPanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Remove Background using AI (RMBG-1.4)"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Fill" IsChecked="{Binding ImageEditor.BackgroundFill.IsPanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Fill transparent background with solid color"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Upscale" IsChecked="{Binding ImageEditor.Upscaling.IsPanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="AI Upscaling (4x-UltraSharp)"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Draw" IsChecked="{Binding ImageEditor.DrawingTools.IsDrawingToolActive, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Drawing Tool - Hold Shift for straight lines"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Inpaint" IsChecked="{Binding ImageEditor.Inpainting.IsPanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="AI Inpainting - Paint over areas to regenerate using ComfyUI"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
          </StackPanel>
          <!-- Separator - always visible -->
          <Border Grid.Column="6" Width="1" Background="#444" Margin="8,4"/>
          <!-- Transform buttons - always visible but disabled when no image -->
          <StackPanel Grid.Column="7" Orientation="Horizontal" Spacing="4">
            <Button Content="L" Command="{Binding ImageEditor.RotateLeftCommand}" Padding="10,6" ToolTip.Tip="Rotate Left 90ï¿½" FontSize="12" FontWeight="Bold"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
            <Button Content="R" Command="{Binding ImageEditor.RotateRightCommand}" Padding="10,6" ToolTip.Tip="Rotate Right 90ï¿½" FontSize="12" FontWeight="Bold"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
            <Button Content="180" Command="{Binding ImageEditor.Rotate180Command}" Padding="8,6" ToolTip.Tip="Rotate 180ï¿½" FontSize="11"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
            <Button Content="H" Command="{Binding ImageEditor.FlipHorizontalCommand}" Padding="10,6" ToolTip.Tip="Flip Horizontal" FontSize="12" FontWeight="Bold"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
            <Button Content="V" Command="{Binding ImageEditor.FlipVerticalCommand}" Padding="10,6" ToolTip.Tip="Flip Vertical" FontSize="12" FontWeight="Bold"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
          </StackPanel>
          <Border Grid.Column="8"/>
          <!-- Save buttons - hidden until image is loaded -->
          <StackPanel Grid.Column="9" Orientation="Horizontal" Spacing="4" IsVisible="{Binding ImageEditor.HasImage, FallbackValue=False}">
            <Button Content="Save As New" Command="{Binding ImageEditor.SaveAsNewCommand}" Background="#2D7D46" Padding="12,6"/>
            <Button Content="Save" Command="{Binding ImageEditor.SaveOverwriteCommand}" Padding="12,6"/>
            <Button Content="Export" Command="{Binding ImageEditor.ExportCommand}" Padding="12,6" ToolTip.Tip="Export image to external location"/>
          </StackPanel>
          <!-- Separator before Reset/Clear - only visible when image is loaded -->
          <Border Grid.Column="10" Width="1" Background="#444" Margin="8,4" IsVisible="{Binding ImageEditor.HasImage, FallbackValue=False}"/>
          <!-- Reset and Clear buttons - hidden until image is loaded -->
          <Button Grid.Column="11" Content="Reset" Command="{Binding ImageEditor.ResetImageCommand}" Margin="0,0,8,0" Padding="12,6"
                  IsVisible="{Binding ImageEditor.HasImage, FallbackValue=False}"/>
          <Button Grid.Column="12" Content="Clear" Command="{Binding ImageEditor.ClearImageCommand}" Padding="12,6"
                  IsVisible="{Binding ImageEditor.HasImage, FallbackValue=False}"/>
        </Grid>
      </Border>
      
      <!-- Image Editor Canvas -->
      <Border Grid.Row="1" Background="#1A1A1A" Margin="16">
        <Grid>
          <!-- Empty state - Drop Zone -->
          <Border x:Name="ImageDropZone" IsVisible="{Binding !ImageEditor.HasImage}"
                  Background="#1A1A1A" BorderThickness="3" BorderBrush="#444" CornerRadius="12"
                  DragDrop.AllowDrop="True">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="16">
              <Border Background="#333" CornerRadius="12" Padding="24">
                <TextBlock Text="IMAGE EDITOR" FontSize="24" Opacity="0.4" HorizontalAlignment="Center" FontWeight="Bold"/>
              </Border>
              <TextBlock Text="No image loaded" FontSize="20" FontWeight="SemiBold" HorizontalAlignment="Center" Opacity="0.8"/>
              <TextBlock Text="Drag and drop an image here" FontSize="14" Foreground="#888" HorizontalAlignment="Center"/>
              <TextBlock Text="or use 'Send to Image Edit' from Dataset Management" FontSize="12" Foreground="#666" HorizontalAlignment="Center"/>
              <Button x:Name="OpenImageButton" Content="+ Open Image" HorizontalAlignment="Center" 
                      Padding="16,10" FontSize="14" Background="#4CAF50" Foreground="White"/>
            </StackPanel>
          </Border>
          <controls:ImageEditorControl x:Name="ImageEditorCanvas"
                                       ImagePath="{Binding ImageEditor.CurrentImagePath}"
                                       IsCropToolActive="{Binding ImageEditor.IsCropToolActive}"
                                       IsDrawingToolActive="{Binding ImageEditor.DrawingTools.IsDrawingToolActive}"
                                       SelectedShapeType="{Binding ImageEditor.DrawingTools.SelectedShapeType}"
                                       ShapeFillMode="{Binding ImageEditor.DrawingTools.ShapeFillMode}"
                                       ShapeStrokeColor="{Binding ImageEditor.DrawingTools.ShapeStrokeColor}"
                                       ShapeFillColor="{Binding ImageEditor.DrawingTools.ShapeFillColor}"
                                       ShapeStrokeWidth="{Binding ImageEditor.DrawingTools.ShapeStrokeWidth}"
                                       IsVisible="{Binding ImageEditor.HasImage, FallbackValue=False}"/>
        </Grid>
      </Border>
      
      <!-- Bottom Status Bar - Information & Zoom -->
      <Border Grid.Row="2" Background="#1E1E1E" Padding="8,0" BorderBrush="#333" BorderThickness="0,1,0,0"
              IsVisible="{Binding ImageEditor.HasImage, FallbackValue=False}">
        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Height="22">
          <TextBlock Text="{Binding ImageEditor.ImageDimensions}" FontSize="10" Opacity="0.7" VerticalAlignment="Center"/>
          <TextBlock Text="|" FontSize="10" Opacity="0.4" VerticalAlignment="Center"/>
          <TextBlock Text="{Binding ImageEditor.ImageDpi, StringFormat='{}{0} DPI'}" FontSize="10" Opacity="0.7" VerticalAlignment="Center"/>
          <TextBlock Text="|" FontSize="10" Opacity="0.4" VerticalAlignment="Center"/>
          <TextBlock Text="{Binding ImageEditor.FileSizeText}" FontSize="10" Opacity="0.7" VerticalAlignment="Center"/>
          <Border Width="0" HorizontalAlignment="Stretch"/>
          <Button Content="Fit" Command="{Binding ImageEditor.ZoomToFitCommand}" Padding="6,0" FontSize="10"/>
          <Button Content="100%" Command="{Binding ImageEditor.ZoomToActualCommand}" Padding="6,0" FontSize="10"/>
          <Slider Minimum="10" Maximum="500" Value="{Binding ImageEditor.ZoomPercentage}" 
                  Width="100" VerticalAlignment="Center" x:Name="ZoomSlider"/>
          <TextBlock Text="{Binding ImageEditor.ZoomPercentageText}" FontSize="10" FontWeight="SemiBold" 
                     Foreground="#4CAF50" VerticalAlignment="Center"/>
        </StackPanel>
      </Border>
    </Grid>
    
    <!-- Right Side Panel - Info -->
    <Border Grid.Column="2" Width="200" Background="#1E1E1E" BorderBrush="#333" BorderThickness="1,0,0,0"
            IsVisible="{Binding ImageEditor.HasImage, FallbackValue=False}">
      <ScrollViewer>
        <StackPanel Margin="12" Spacing="16">
          <!-- Layers Panel - At top -->
          <StackPanel Spacing="8">
            <TextBlock Text="Layers" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="8">
                <!-- Layer Actions -->
                <StackPanel Orientation="Horizontal" Spacing="2">
                  <Button Content="+" Command="{Binding ImageEditor.LayerPanel.AddLayerCommand}" Padding="6,2" FontSize="12" 
                          ToolTip.Tip="Add new layer" FontWeight="Bold"/>
                  <Button Content="-" Command="{Binding ImageEditor.LayerPanel.DeleteLayerCommand}" Padding="6,2" FontSize="12" 
                          ToolTip.Tip="Delete selected layer" FontWeight="Bold"/>
                  <Button Content="D" Command="{Binding ImageEditor.LayerPanel.DuplicateLayerCommand}" Padding="6,2" FontSize="10" 
                          ToolTip.Tip="Duplicate selected layer"/>
                  <Button Content="â†‘" Command="{Binding ImageEditor.LayerPanel.MoveLayerUpCommand}" Padding="6,2" FontSize="12" 
                          ToolTip.Tip="Move layer up"/>
                  <Button Content="â†“" Command="{Binding ImageEditor.LayerPanel.MoveLayerDownCommand}" Padding="6,2" FontSize="12" 
                          ToolTip.Tip="Move layer down"/>
                </StackPanel>
                
                <!-- Layer List -->
                <Border Background="#252525" CornerRadius="2" MinHeight="100" MaxHeight="200">
                  <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding ImageEditor.LayerPanel.Layers}">
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Button Command="{Binding SelectCommand}" Padding="0" Margin="1" HorizontalAlignment="Stretch"
                                  Background="{Binding IsSelected, Converter={x:Static converters:BoolConverters.BoolToLayerBackground}}">
                            <Grid ColumnDefinitions="Auto,*,Auto" Height="36" Margin="4,2">
                              <!-- Visibility Toggle -->
                              <ToggleButton Grid.Column="0" IsChecked="{Binding IsVisible, Mode=TwoWay}" 
                                            Padding="4,2" Margin="0,0,4,0" VerticalAlignment="Center"
                                            ToolTip.Tip="Toggle visibility">
                                <TextBlock Text="ðŸ‘" FontSize="10"/>
                              </ToggleButton>
                              
                              <!-- Thumbnail and Name -->
                              <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                <Border Width="28" Height="28" CornerRadius="2" Background="#333" ClipToBounds="True">
                                  <Image Source="{Binding Thumbnail}" Stretch="Uniform"/>
                                </Border>
                                <TextBlock Text="{Binding Name}" FontSize="10" VerticalAlignment="Center" 
                                           TextTrimming="CharacterEllipsis" MaxWidth="80"/>
                              </StackPanel>
                              
                              <!-- Opacity -->
                              <TextBlock Grid.Column="2" Text="{Binding OpacityText}" FontSize="9" Opacity="0.6" 
                                         VerticalAlignment="Center" Margin="4,0"/>
                            </Grid>
                          </Button>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </ScrollViewer>
                </Border>
                
                <!-- Selected Layer Properties -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.LayerPanel.SelectedLayer, Converter={x:Static ObjectConverters.IsNotNull}}">
                  <Border Height="1" Background="#444" Margin="0,2"/>
                  <TextBlock Text="Layer Opacity" FontSize="10" Opacity="0.7"/>
                  <Grid ColumnDefinitions="*,35">
                    <Slider Grid.Column="0" Minimum="0" Maximum="100" 
                            Value="{Binding ImageEditor.LayerPanel.SelectedLayer.OpacityPercent}" TickFrequency="1"/>
                    <TextBlock Grid.Column="1" Text="{Binding ImageEditor.LayerPanel.SelectedLayer.OpacityText}" 
                               FontSize="9" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,2"/>
                
                <!-- Merge/Flatten Options -->
                <StackPanel Spacing="4">
                  <Button Content="Merge Down" Command="{Binding ImageEditor.LayerPanel.MergeLayerDownCommand}" 
                          HorizontalAlignment="Stretch" Padding="6,3" FontSize="10"/>
                  <Button Content="Flatten All" Command="{Binding ImageEditor.LayerPanel.FlattenLayersCommand}" 
                          HorizontalAlignment="Stretch" Padding="6,3" FontSize="10"/>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,2"/>
                
                <!-- Save Layered TIFF -->
                <Button Content="Save Layered TIFF" Command="{Binding ImageEditor.LayerPanel.SaveLayeredTiffCommand}" 
                        HorizontalAlignment="Stretch" Padding="6,4" FontSize="10"
                        Background="#5E35B1" ToolTip.Tip="Export as multi-layer TIFF file"/>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Crop Tool Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.IsCropToolActive, FallbackValue=False}">
            <TextBlock Text="Crop Tool" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="8">
                <TextBlock Text="Drag on the image to select the crop region." FontSize="11" Opacity="0.7" TextWrapping="Wrap"/>
                
                <!-- Crop Resolution -->
                <TextBlock Text="{Binding ImageEditor.CropResolutionText}" FontSize="12" FontWeight="SemiBold" 
                           Foreground="#4CAF50" HorizontalAlignment="Center"
                           IsVisible="{Binding ImageEditor.CropResolutionText, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Aspect Ratio Presets -->
                <TextBlock Text="Aspect Ratio" FontSize="11" Opacity="0.7"/>
                <StackPanel Spacing="4">
                  <!-- Row 1: Fit & Fill -->
                  <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                    <Button Content="Fit" Command="{Binding ImageEditor.FitCropCommand}" Padding="8,4" FontSize="10"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                            ToolTip.Tip="Expand crop to fill image, keeping current aspect ratio"/>
                    <Button Content="Fill" Command="{Binding ImageEditor.FillCropCommand}" Padding="8,4" FontSize="10"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                            ToolTip.Tip="Set crop to cover the entire image"/>
                  </StackPanel>
                  <!-- Row 2: Aspect Ratio Presets -->
                  <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                    <Button Content="{Binding ImageEditor.CropAspectInverted, Converter={x:Static converters:BoolConverters.BoolToCropRatio16x9}}" 
                            Command="{Binding ImageEditor.SetCropAspectRatioCommand}" CommandParameter="16:9" 
                            Padding="8,4" FontSize="10"/>
                    <Button Content="1:1" Command="{Binding ImageEditor.SetCropAspectRatioCommand}" CommandParameter="1:1" 
                            Padding="8,4" FontSize="10"/>
                    <Button Content="{Binding ImageEditor.CropAspectInverted, Converter={x:Static converters:BoolConverters.BoolToCropRatio4x3}}" 
                            Command="{Binding ImageEditor.SetCropAspectRatioCommand}" CommandParameter="4:3" 
                            Padding="8,4" FontSize="10"/>
                    <Button Content="{Binding ImageEditor.CropAspectInverted, Converter={x:Static converters:BoolConverters.BoolToCropRatio5x4}}" 
                            Command="{Binding ImageEditor.SetCropAspectRatioCommand}" CommandParameter="5:4" 
                            Padding="8,4" FontSize="10"/>
                  </StackPanel>
                  <!-- Row 3: Switch -->
                  <Button Content="Switch" Command="{Binding ImageEditor.SwitchCropAspectRatioCommand}" Padding="8,4" FontSize="10"
                          HorizontalAlignment="Center"
                          ToolTip.Tip="Switch between W:H and H:W"/>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*" Margin="0,4,0,0">
                  <Button Grid.Column="0" Content="Cancel" Command="{Binding ImageEditor.CancelCropCommand}" HorizontalAlignment="Stretch" Margin="0,0,2,0"/>
                  <Button Grid.Column="1" Content="Apply" Command="{Binding ImageEditor.ApplyCropCommand}" Background="#2D7D46" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Color Balance Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.ColorTools.IsColorBalancePanelOpen, FallbackValue=False}">
            <TextBlock Text="Color Balance" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="10">
                <!-- Range Selection -->
                <TextBlock Text="Select Range" FontSize="11" Opacity="0.7"/>
                <StackPanel Spacing="4">
                  <RadioButton Content="Shadows" IsChecked="{Binding ImageEditor.ColorTools.IsShadowsSelected, Mode=TwoWay}" GroupName="ColorBalanceRange"/>
                  <RadioButton Content="Midtones" IsChecked="{Binding ImageEditor.ColorTools.IsMidtonesSelected, Mode=TwoWay}" GroupName="ColorBalanceRange"/>
                  <RadioButton Content="Highlights" IsChecked="{Binding ImageEditor.ColorTools.IsHighlightsSelected, Mode=TwoWay}" GroupName="ColorBalanceRange"/>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Cyan - Red -->
                <Grid ColumnDefinitions="50,*,40">
                  <TextBlock Grid.Column="0" Text="Cyan" FontSize="11" VerticalAlignment="Center" Foreground="#00FFFF"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.ColorTools.ColorBalanceCyanRed}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="Red" FontSize="11" VerticalAlignment="Center" HorizontalAlignment="Right" Foreground="#FF6666"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.ColorTools.ColorBalanceCyanRed, StringFormat='{}{0:F1}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <!-- Magenta - Green -->
                <Grid ColumnDefinitions="50,*,40">
                  <TextBlock Grid.Column="0" Text="Magenta" FontSize="11" VerticalAlignment="Center" Foreground="#FF00FF"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.ColorTools.ColorBalanceMagentaGreen}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="Green" FontSize="11" VerticalAlignment="Center" HorizontalAlignment="Right" Foreground="#66FF66"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.ColorTools.ColorBalanceMagentaGreen, StringFormat='{}{0:F1}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <!-- Yellow - Blue -->
                <Grid ColumnDefinitions="50,*,40">
                  <TextBlock Grid.Column="0" Text="Yellow" FontSize="11" VerticalAlignment="Center" Foreground="#FFFF00"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.ColorTools.ColorBalanceYellowBlue}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="Blue" FontSize="11" VerticalAlignment="Center" HorizontalAlignment="Right" Foreground="#6666FF"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.ColorTools.ColorBalanceYellowBlue, StringFormat='{}{0:F1}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Preserve Luminosity -->
                <CheckBox Content="Preserve Luminosity" IsChecked="{Binding ImageEditor.ColorTools.PreserveLuminosity}" FontSize="11"/>
                
                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*" Margin="0,4,0,0">
                  <Button Grid.Column="0" Content="Reset" Command="{Binding ImageEditor.ColorTools.ResetColorBalanceRangeCommand}" HorizontalAlignment="Stretch" Margin="0,0,2,0"/>
                  <Button Grid.Column="1" Content="Apply" Command="{Binding ImageEditor.ColorTools.ApplyColorBalanceCommand}" Background="#2D7D46" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Brightness/Contrast Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.ColorTools.IsBrightnessContrastPanelOpen, FallbackValue=False}">
            <TextBlock Text="Brightness/Contrast" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="10">
                <!-- Brightness -->
                <TextBlock Text="Brightness" FontSize="11" Opacity="0.7"/>
                <Grid ColumnDefinitions="40,*,40">
                  <TextBlock Grid.Column="0" Text="-" FontSize="16" VerticalAlignment="Center" Opacity="0.5" HorizontalAlignment="Center"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.ColorTools.Brightness}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="+" FontSize="16" VerticalAlignment="Center" Opacity="0.5" HorizontalAlignment="Center"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.ColorTools.Brightness, StringFormat='{}{0:F0}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <!-- Contrast -->
                <TextBlock Text="Contrast" FontSize="11" Opacity="0.7"/>
                <Grid ColumnDefinitions="40,*,40">
                  <TextBlock Grid.Column="0" Text="-" FontSize="16" VerticalAlignment="Center" Opacity="0.5" HorizontalAlignment="Center"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.ColorTools.Contrast}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="+" FontSize="16" VerticalAlignment="Center" Opacity="0.5" HorizontalAlignment="Center"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.ColorTools.Contrast, StringFormat='{}{0:F0}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*" Margin="0,4,0,0">
                  <Button Grid.Column="0" Content="Reset" Command="{Binding ImageEditor.ColorTools.ResetBrightnessContrastCommand}" HorizontalAlignment="Stretch" Margin="0,0,2,0"/>
                  <Button Grid.Column="1" Content="Apply" Command="{Binding ImageEditor.ColorTools.ApplyBrightnessContrastCommand}" Background="#2D7D46" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Background Removal Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.BackgroundRemoval.IsPanelOpen, FallbackValue=False}">
            <TextBlock Text="Background Removal" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="8">
                <!-- Model Status -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Model Status" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Border Width="8" Height="8" CornerRadius="4"
                            Background="{Binding ImageEditor.BackgroundRemoval.IsModelReady, Converter={x:Static converters:BoolConverters.BoolToStatusBrush}}"/>
                    <TextBlock FontSize="12" Opacity="0.9"
                               Text="{Binding ImageEditor.BackgroundRemoval.IsModelReady, Converter={x:Static converters:BoolConverters.BoolToModelStatusText}}"/>
                  </StackPanel>
                </StackPanel>
                
                <!-- Download Button (shown when model missing and not busy) -->
                <Button Content="Download Model (~176 MB)" 
                        Command="{Binding ImageEditor.BackgroundRemoval.DownloadModelCommand}"
                        HorizontalAlignment="Stretch"
                        Background="#5E35B1"
                        Foreground="White"
                        IsVisible="{Binding ImageEditor.BackgroundRemoval.IsModelMissing}"
                        IsEnabled="{Binding !ImageEditor.BackgroundRemoval.IsBusy}"/>
                
                <!-- Progress (shown when busy) -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.BackgroundRemoval.IsBusy}">
                  <TextBlock Text="{Binding ImageEditor.BackgroundRemoval.Status}" 
                             FontSize="11" Opacity="0.8" TextWrapping="Wrap"/>
                  <Border Background="#333" CornerRadius="2" Height="6" Margin="0,2,0,0">
                    <Border Background="#5E35B1" CornerRadius="2" HorizontalAlignment="Left"
                            Width="{Binding ImageEditor.BackgroundRemoval.Progress, Converter={x:Static converters:BoolConverters.PercentageToWidth}}"/>
                  </Border>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Instructions -->
                <TextBlock Text="Uses RMBG-1.4 AI model to remove backgrounds. Runs locally on GPU/CPU." 
                           FontSize="10" Opacity="0.6" TextWrapping="Wrap"/>
                <TextBlock Text="{Binding ImageEditor.BackgroundRemoval.IsModelReady, Converter={x:Static converters:BoolConverters.BoolToModelPathText}}"
                           FontSize="9" Opacity="0.4" TextWrapping="Wrap"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Action Buttons -->
                <StackPanel Spacing="4" Margin="0,4,0,0">
                  <Button Content="Remove BG" Command="{Binding ImageEditor.BackgroundRemoval.RemoveBackgroundCommand}" 
                          Background="#2D7D46" HorizontalAlignment="Stretch"
                          ToolTip.Tip="Remove background (destructive)"
                          IsEnabled="{Binding ImageEditor.BackgroundRemoval.IsModelReady}"/>
                  <Button Content="To Layer" Command="{Binding ImageEditor.BackgroundRemoval.RemoveBackgroundToLayerCommand}" 
                          Background="#5E35B1" HorizontalAlignment="Stretch"
                          ToolTip.Tip="Keep background as separate layer (non-destructive)"
                          IsEnabled="{Binding ImageEditor.BackgroundRemoval.IsModelReady}"/>
                </StackPanel>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Background Fill Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.BackgroundFill.IsPanelOpen, FallbackValue=False}">
            <TextBlock Text="Background Fill" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="10">
                <!-- Color Preview -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Fill Color" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="Auto,*">
                    <Border Grid.Column="0" Width="32" Height="32" CornerRadius="4" BorderBrush="#555" BorderThickness="1" Margin="0,0,8,0">
                      <Border.Background>
                        <SolidColorBrush Color="{Binding ImageEditor.BackgroundFill.FillColor}"/>
                      </Border.Background>
                    </Border>
                    <TextBlock Grid.Column="1" Text="{Binding ImageEditor.BackgroundFill.FillColorHex}" 
                               VerticalAlignment="Center" FontSize="12" FontFamily="Consolas" Opacity="0.9"/>
                  </Grid>
                </StackPanel>
                
                <!-- Preset Colors -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Presets" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="White"
                            Command="{Binding ImageEditor.BackgroundFill.SetPresetCommand}" CommandParameter="White">
                      <Border Width="24" Height="24" CornerRadius="2" Background="White"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Black"
                            Command="{Binding ImageEditor.BackgroundFill.SetPresetCommand}" CommandParameter="Black">
                      <Border Width="24" Height="24" CornerRadius="2" Background="Black" BorderBrush="#555" BorderThickness="1"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Gray"
                            Command="{Binding ImageEditor.BackgroundFill.SetPresetCommand}" CommandParameter="Gray">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#808080"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Green"
                            Command="{Binding ImageEditor.BackgroundFill.SetPresetCommand}" CommandParameter="Green">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#00B140"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Blue"
                            Command="{Binding ImageEditor.BackgroundFill.SetPresetCommand}" CommandParameter="Blue">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#0078D7"/>
                    </Button>
                  </StackPanel>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- RGB Sliders -->
                <StackPanel Spacing="6">
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="R" FontSize="11" VerticalAlignment="Center" Foreground="#FF6666" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.BackgroundFill.FillRed}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.BackgroundFill.FillRed}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="G" FontSize="11" VerticalAlignment="Center" Foreground="#66FF66" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.BackgroundFill.FillGreen}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.BackgroundFill.FillGreen}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="B" FontSize="11" VerticalAlignment="Center" Foreground="#6666FF" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.BackgroundFill.FillBlue}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.BackgroundFill.FillBlue}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Action Button -->
                <Button Content="Apply Fill" Command="{Binding ImageEditor.BackgroundFill.ApplyCommand}" 
                        Background="#2D7D46" HorizontalAlignment="Stretch"/>
                        
                <!-- Instructions -->
                <TextBlock Text="Fills transparent areas with the selected color. Use after removing background." 
                           FontSize="10" Opacity="0.5" TextWrapping="Wrap" Margin="0,4,0,0"/>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- AI Upscaling Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.Upscaling.IsPanelOpen, FallbackValue=False}">
            <TextBlock Text="AI Upscaling" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="8">
                <!-- Model Status -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Model Status" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Border Width="8" Height="8" CornerRadius="4"
                            Background="{Binding ImageEditor.Upscaling.IsModelReady, Converter={x:Static converters:BoolConverters.BoolToStatusBrush}}"/>
                    <TextBlock FontSize="12" Opacity="0.9"
                               Text="{Binding ImageEditor.Upscaling.IsModelReady, Converter={x:Static converters:BoolConverters.BoolToUpscalingModelStatusText}}"/>
                  </StackPanel>
                </StackPanel>
                
                <!-- Download Button (shown when model missing and not busy) -->
                <Button Content="Download Model (~67 MB)" 
                        Command="{Binding ImageEditor.Upscaling.DownloadModelCommand}"
                        HorizontalAlignment="Stretch"
                        Background="#5E35B1"
                        Foreground="White"
                        IsVisible="{Binding ImageEditor.Upscaling.IsModelMissing}"
                        IsEnabled="{Binding !ImageEditor.Upscaling.IsBusy}"/>
                
                <!-- Progress (shown when busy) -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.Upscaling.IsBusy}">
                  <TextBlock Text="{Binding ImageEditor.Upscaling.Status}" 
                             FontSize="11" Opacity="0.8" TextWrapping="Wrap"/>
                  <Border Background="#333" CornerRadius="2" Height="6" Margin="0,2,0,0">
                    <Border Background="#5E35B1" CornerRadius="2" HorizontalAlignment="Left"
                            Width="{Binding ImageEditor.Upscaling.Progress, Converter={x:Static converters:BoolConverters.PercentageToWidth}}"/>
                  </Border>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Scale Slider (only show when model is ready) -->
                <StackPanel Spacing="6" IsVisible="{Binding ImageEditor.Upscaling.IsModelReady}">
                  <TextBlock Text="Target Scale" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="Auto,*,Auto">
                    <TextBlock Grid.Column="0" Text="1.1x" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                    <Slider Grid.Column="1" Minimum="1.1" Maximum="4.0" Value="{Binding ImageEditor.Upscaling.TargetScale}" 
                            TickFrequency="0.1" Margin="8,0"/>
                    <TextBlock Grid.Column="2" Text="4.0x" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                  </Grid>
                  <TextBlock Text="{Binding ImageEditor.Upscaling.TargetScaleText}" 
                             FontSize="18" FontWeight="SemiBold" Foreground="#5E35B1" HorizontalAlignment="Center"/>
                  
                  <!-- Output Dimensions Preview -->
                  <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="4" Margin="0,4,0,0">
                    <TextBlock Text="Output:" FontSize="10" Opacity="0.6"/>
                    <TextBlock Text="{Binding ImageEditor.Upscaling.OutputDimensions}" FontSize="10" Opacity="0.8"/>
                  </StackPanel>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Instructions -->
                <TextBlock Text="Uses 4x-UltraSharp AI model for high-quality upscaling. Runs locally on GPU/CPU." 
                           FontSize="10" Opacity="0.6" TextWrapping="Wrap"/>
                
                <!-- Performance Warning -->
                <Border Background="#3D2D00" CornerRadius="4" Padding="6" Margin="0,4,0,0" 
                        IsVisible="{Binding ImageEditor.Upscaling.IsModelReady}">
                  <TextBlock Text="? Processing can take several minutes for large images. A 4x upscale is always computed internally, even for lower target scales." 
                             FontSize="9" Opacity="0.9" TextWrapping="Wrap" Foreground="#FFCC00"/>
                </Border>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Action Button -->
                <Button Content="Apply Upscale" Command="{Binding ImageEditor.Upscaling.UpscaleCommand}" 
                        Background="#2D7D46" HorizontalAlignment="Stretch"
                        IsEnabled="{Binding ImageEditor.Upscaling.IsModelReady}"/>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Drawing Tool Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.DrawingTools.IsDrawingToolActive, FallbackValue=False}">
            <TextBlock Text="Drawing Tool" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="10">
                <!-- Shape Type Selection -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Shape Type" FontSize="11" Opacity="0.7"/>
                  <StackPanel Spacing="4">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <ToggleButton Content="Free" IsChecked="{Binding ImageEditor.DrawingTools.IsShapeFreehand, Mode=TwoWay}" 
                                    Padding="8,4" FontSize="10" ToolTip.Tip="Freehand Drawing"/>
                      <ToggleButton Content="â–¡" IsChecked="{Binding ImageEditor.DrawingTools.IsShapeRectangle, Mode=TwoWay}" 
                                    Padding="8,4" FontSize="14" ToolTip.Tip="Rectangle"/>
                      <ToggleButton Content="â—‹" IsChecked="{Binding ImageEditor.DrawingTools.IsShapeEllipse, Mode=TwoWay}" 
                                    Padding="8,4" FontSize="14" ToolTip.Tip="Ellipse/Circle"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <ToggleButton Content="â†’" IsChecked="{Binding ImageEditor.DrawingTools.IsShapeArrow, Mode=TwoWay}" 
                                    Padding="8,4" FontSize="14" ToolTip.Tip="Arrow"/>
                      <ToggleButton Content="/" IsChecked="{Binding ImageEditor.DrawingTools.IsShapeLine, Mode=TwoWay}" 
                                    Padding="8,4" FontSize="14" ToolTip.Tip="Line"/>
                      <ToggleButton Content="âœ•" IsChecked="{Binding ImageEditor.DrawingTools.IsShapeCross, Mode=TwoWay}" 
                                    Padding="8,4" FontSize="14" ToolTip.Tip="Cross/X"/>
                    </StackPanel>
                  </StackPanel>
                </StackPanel>
                
                <!-- Instructions -->
                <TextBlock Text="Click and drag to draw. Hold Shift for straight lines." 
                           FontSize="10" Opacity="0.6" TextWrapping="Wrap"
                           IsVisible="{Binding ImageEditor.DrawingTools.IsShapeFreehand}"/>
                <TextBlock Text="Click and drag to draw. Hold Ctrl for square/circle." 
                           FontSize="10" Opacity="0.6" TextWrapping="Wrap"
                           IsVisible="{Binding ImageEditor.DrawingTools.IsShapeMode}"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Fill Mode (only for shapes, not freehand) -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeMode}">
                  <TextBlock Text="Fill Mode" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <ToggleButton Content="Outline" IsChecked="{Binding ImageEditor.DrawingTools.IsShapeStrokeOnly, Mode=TwoWay}" 
                                  Padding="6,4" FontSize="10" ToolTip.Tip="Outline only"/>
                    <ToggleButton Content="Fill" IsChecked="{Binding ImageEditor.DrawingTools.IsShapeFillOnly, Mode=TwoWay}" 
                                  Padding="6,4" FontSize="10" ToolTip.Tip="Fill only"/>
                    <ToggleButton Content="Both" IsChecked="{Binding ImageEditor.DrawingTools.IsShapeFillAndStroke, Mode=TwoWay}" 
                                  Padding="6,4" FontSize="10" ToolTip.Tip="Fill and outline"/>
                  </StackPanel>
                  <Border Height="1" Background="#444" Margin="0,4"/>
                </StackPanel>
                
                <!-- Freehand Brush Color -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeFreehand}">
                  <TextBlock Text="Brush Color" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="Auto,*">
                    <Border Grid.Column="0" Width="32" Height="32" CornerRadius="4" BorderBrush="#555" BorderThickness="1" Margin="0,0,8,0">
                      <Border.Background>
                        <SolidColorBrush Color="{Binding ImageEditor.DrawingTools.DrawingBrushColor}"/>
                      </Border.Background>
                    </Border>
                    <TextBlock Grid.Column="1" Text="{Binding ImageEditor.DrawingTools.DrawingBrushColorHex}" 
                               VerticalAlignment="Center" FontSize="12" FontFamily="Consolas" Opacity="0.9"/>
                  </Grid>
                </StackPanel>
                
                <!-- Shape Stroke Color -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeMode}">
                  <TextBlock Text="Stroke Color" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="Auto,*">
                    <Border Grid.Column="0" Width="32" Height="32" CornerRadius="4" BorderBrush="#555" BorderThickness="1" Margin="0,0,8,0">
                      <Border.Background>
                        <SolidColorBrush Color="{Binding ImageEditor.DrawingTools.ShapeStrokeColor}"/>
                      </Border.Background>
                    </Border>
                    <TextBlock Grid.Column="1" Text="{Binding ImageEditor.DrawingTools.ShapeStrokeColorHex}" 
                               VerticalAlignment="Center" FontSize="12" FontFamily="Consolas" Opacity="0.9"/>
                  </Grid>
                </StackPanel>
                
                <!-- Shape Fill Color (only for fill modes) -->
                <StackPanel Spacing="4" IsVisible="{Binding !ImageEditor.DrawingTools.IsShapeStrokeOnly}">
                  <StackPanel.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                      <Binding Path="ImageEditor.DrawingTools.IsShapeMode"/>
                      <Binding Path="!ImageEditor.DrawingTools.IsShapeStrokeOnly"/>
                    </MultiBinding>
                  </StackPanel.IsVisible>
                  <TextBlock Text="Fill Color" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="Auto,*">
                    <Border Grid.Column="0" Width="32" Height="32" CornerRadius="4" BorderBrush="#555" BorderThickness="1" Margin="0,0,8,0">
                      <Border.Background>
                        <SolidColorBrush Color="{Binding ImageEditor.DrawingTools.ShapeFillColor}"/>
                      </Border.Background>
                    </Border>
                    <TextBlock Grid.Column="1" Text="{Binding ImageEditor.DrawingTools.ShapeFillColorHex}" 
                               VerticalAlignment="Center" FontSize="12" FontFamily="Consolas" Opacity="0.9"/>
                  </Grid>
                </StackPanel>
                
                <!-- Preset Colors for Freehand -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeFreehand}">
                  <TextBlock Text="Presets" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="2">
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="White"
                            Command="{Binding ImageEditor.DrawingTools.SetDrawingColorPresetCommand}" CommandParameter="White">
                      <Border Width="20" Height="20" CornerRadius="2" Background="White"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Black"
                            Command="{Binding ImageEditor.DrawingTools.SetDrawingColorPresetCommand}" CommandParameter="Black">
                      <Border Width="20" Height="20" CornerRadius="2" Background="Black" BorderBrush="#555" BorderThickness="1"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Red"
                            Command="{Binding ImageEditor.DrawingTools.SetDrawingColorPresetCommand}" CommandParameter="Red">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#FF0000"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Green"
                            Command="{Binding ImageEditor.DrawingTools.SetDrawingColorPresetCommand}" CommandParameter="Green">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#00FF00"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Blue"
                            Command="{Binding ImageEditor.DrawingTools.SetDrawingColorPresetCommand}" CommandParameter="Blue">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#0000FF"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Yellow"
                            Command="{Binding ImageEditor.DrawingTools.SetDrawingColorPresetCommand}" CommandParameter="Yellow">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#FFFF00"/>
                    </Button>
                  </StackPanel>
                </StackPanel>
                
                <!-- Preset Colors for Shape Stroke -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeMode}">
                  <TextBlock Text="Stroke Presets" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="2">
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="White"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeStrokePresetCommand}" CommandParameter="White">
                      <Border Width="20" Height="20" CornerRadius="2" Background="White"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Black"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeStrokePresetCommand}" CommandParameter="Black">
                      <Border Width="20" Height="20" CornerRadius="2" Background="Black" BorderBrush="#555" BorderThickness="1"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Red"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeStrokePresetCommand}" CommandParameter="Red">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#FF0000"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Green"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeStrokePresetCommand}" CommandParameter="Green">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#00FF00"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Blue"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeStrokePresetCommand}" CommandParameter="Blue">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#0000FF"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Yellow"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeStrokePresetCommand}" CommandParameter="Yellow">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#FFFF00"/>
                    </Button>
                  </StackPanel>
                </StackPanel>
                
                <!-- Preset Colors for Shape Fill -->
                <StackPanel Spacing="4">
                  <StackPanel.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                      <Binding Path="ImageEditor.DrawingTools.IsShapeMode"/>
                      <Binding Path="!ImageEditor.DrawingTools.IsShapeStrokeOnly"/>
                    </MultiBinding>
                  </StackPanel.IsVisible>
                  <TextBlock Text="Fill Presets" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="2">
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="White"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeFillPresetCommand}" CommandParameter="White">
                      <Border Width="20" Height="20" CornerRadius="2" Background="White"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Black"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeFillPresetCommand}" CommandParameter="Black">
                      <Border Width="20" Height="20" CornerRadius="2" Background="Black" BorderBrush="#555" BorderThickness="1"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Red"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeFillPresetCommand}" CommandParameter="Red">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#FF0000"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Green"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeFillPresetCommand}" CommandParameter="Green">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#00FF00"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Blue"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeFillPresetCommand}" CommandParameter="Blue">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#0000FF"/>
                    </Button>
                    <Button Width="24" Height="24" Padding="0" ToolTip.Tip="Yellow"
                            Command="{Binding ImageEditor.DrawingTools.SetShapeFillPresetCommand}" CommandParameter="Yellow">
                      <Border Width="20" Height="20" CornerRadius="2" Background="#FFFF00"/>
                    </Button>
                  </StackPanel>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- RGB Sliders for Freehand -->
                <StackPanel Spacing="6" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeFreehand}">
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="R" FontSize="11" VerticalAlignment="Center" Foreground="#FF6666" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingTools.DrawingBrushRed}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.DrawingBrushRed}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="G" FontSize="11" VerticalAlignment="Center" Foreground="#66FF66" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingTools.DrawingBrushGreen}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.DrawingBrushGreen}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="B" FontSize="11" VerticalAlignment="Center" Foreground="#6666FF" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingTools.DrawingBrushBlue}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.DrawingBrushBlue}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <!-- Stroke RGB Sliders for Shapes -->
                <StackPanel Spacing="6" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeMode}">
                  <TextBlock Text="Stroke RGB" FontSize="10" Opacity="0.6"/>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="R" FontSize="11" VerticalAlignment="Center" Foreground="#FF6666" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingTools.ShapeStrokeRed}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.ShapeStrokeRed}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="G" FontSize="11" VerticalAlignment="Center" Foreground="#66FF66" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingTools.ShapeStrokeGreen}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.ShapeStrokeGreen}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="B" FontSize="11" VerticalAlignment="Center" Foreground="#6666FF" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingTools.ShapeStrokeBlue}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.ShapeStrokeBlue}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <!-- Fill RGB Sliders for Shapes -->
                <StackPanel Spacing="6">
                  <StackPanel.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                      <Binding Path="ImageEditor.DrawingTools.IsShapeMode"/>
                      <Binding Path="!ImageEditor.DrawingTools.IsShapeStrokeOnly"/>
                    </MultiBinding>
                  </StackPanel.IsVisible>
                  <TextBlock Text="Fill RGB" FontSize="10" Opacity="0.6"/>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="R" FontSize="11" VerticalAlignment="Center" Foreground="#FF6666" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingTools.ShapeFillRed}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.ShapeFillRed}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="G" FontSize="11" VerticalAlignment="Center" Foreground="#66FF66" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingTools.ShapeFillGreen}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.ShapeFillGreen}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="B" FontSize="11" VerticalAlignment="Center" Foreground="#6666FF" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingTools.ShapeFillBlue}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.ShapeFillBlue}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Brush Size for Freehand -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeFreehand}">
                  <TextBlock Text="Brush Size" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="35,*,50">
                    <TextBlock Grid.Column="0" Text="1" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                    <Slider Grid.Column="1" Minimum="1" Maximum="100" Value="{Binding ImageEditor.DrawingTools.DrawingBrushSize}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.DrawingBrushSizeText}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <!-- Stroke Width for Shapes -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeMode}">
                  <TextBlock Text="Stroke Width" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="35,*,50">
                    <TextBlock Grid.Column="0" Text="1" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                    <Slider Grid.Column="1" Minimum="1" Maximum="50" Value="{Binding ImageEditor.DrawingTools.ShapeStrokeWidth}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingTools.ShapeStrokeWidthText}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeFreehand}"/>
                
                <!-- Brush Shape for Freehand -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.DrawingTools.IsShapeFreehand}">
                  <TextBlock Text="Brush Shape" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <RadioButton Content="Round" IsChecked="{Binding ImageEditor.DrawingTools.IsRoundBrush, Mode=TwoWay}" GroupName="BrushShape"/>
                    <RadioButton Content="Square" IsChecked="{Binding ImageEditor.DrawingTools.IsSquareBrush, Mode=TwoWay}" GroupName="BrushShape"/>
                  </StackPanel>
                </StackPanel>
                
                <!-- Placed Shape Actions (visible when a shape is placed and awaiting commit) -->
                <StackPanel Spacing="6" IsVisible="{Binding ImageEditor.DrawingTools.HasPlacedShape}">
                  <Border Height="1" Background="#444" Margin="0,4"/>
                  <TextBlock Text="Shape placed â€” drag to move, corners to resize, top handle to rotate." 
                             FontSize="10" Opacity="0.6" TextWrapping="Wrap"/>
                  <Grid ColumnDefinitions="*,*" Margin="0,4,0,0">
                    <Button Grid.Column="0" Content="Cancel" Command="{Binding ImageEditor.DrawingTools.CancelPlacedShapeCommand}" 
                            HorizontalAlignment="Stretch" Margin="0,0,2,0"/>
                    <Button Grid.Column="1" Content="Apply" Command="{Binding ImageEditor.DrawingTools.CommitPlacedShapeCommand}" 
                            Background="#2D7D46" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                  </Grid>
                  <TextBlock Text="Enter = Apply, Esc = Cancel, âœ• = Delete" FontSize="9" Opacity="0.4" HorizontalAlignment="Center"/>
                </StackPanel>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Inpainting Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.Inpainting.IsPanelOpen, FallbackValue=False}">
            <TextBlock Text="Inpainting" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="10">
                <!-- Instructions -->
                <TextBlock Text="Paint over areas you want AI to regenerate. Masked areas appear as a checkerboard pattern." 
                           FontSize="10" Opacity="0.7" TextWrapping="Wrap"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Inpaint Base Image -->
                <TextBlock Text="Base Image" FontSize="11" Opacity="0.7"/>
                <Border Background="#252525" CornerRadius="4" Padding="4" MinHeight="60">
                  <Grid RowDefinitions="Auto,Auto">
                    <Border Grid.Row="0" CornerRadius="2" ClipToBounds="True" HorizontalAlignment="Center"
                            IsVisible="{Binding ImageEditor.Inpainting.HasBase}">
                      <Image Source="{Binding ImageEditor.Inpainting.BaseThumbnail}" MaxHeight="100" Stretch="Uniform"/>
                    </Border>
                    <TextBlock Grid.Row="0" Text="No base captured" FontSize="10" Opacity="0.4"
                               HorizontalAlignment="Center" VerticalAlignment="Center"
                               IsVisible="{Binding !ImageEditor.Inpainting.HasBase}"/>
                    <Button Grid.Row="1" Content="Use Current as Base" 
                            Command="{Binding ImageEditor.Inpainting.UseCurrentAsBaseCommand}"
                            HorizontalAlignment="Stretch" Padding="6,4" FontSize="10" Margin="0,4,0,0"
                            ToolTip.Tip="Capture the current flattened state as the source image for all future inpaint generations"/>
                  </Grid>
                </Border>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Positive Prompt -->
                <TextBlock Text="Prompt" FontSize="11" Opacity="0.7"/>
                <TextBox x:Name="InpaintPromptTextBox"
                         Text="{Binding ImageEditor.Inpainting.PositivePrompt, Mode=TwoWay}"
                         Watermark="Describe what to generate..."
                         TextWrapping="Wrap" AcceptsReturn="True"
                         MinHeight="60" MaxHeight="120" FontSize="11"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Brush Size -->
                <TextBlock Text="Brush Size" FontSize="11" Opacity="0.7"/>
                <Grid ColumnDefinitions="35,*,50">
                  <TextBlock Grid.Column="0" Text="1" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                  <Slider Grid.Column="1" Minimum="1" Maximum="200" Value="{Binding ImageEditor.Inpainting.BrushSize}" TickFrequency="1"/>
                  <TextBlock Grid.Column="2" Text="{Binding ImageEditor.Inpainting.BrushSizeText}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                </Grid>
                
                <!-- Mask Feather -->
                <TextBlock Text="Mask Feather" FontSize="11" Opacity="0.7"/>
                <Grid ColumnDefinitions="35,*,50">
                  <TextBlock Grid.Column="0" Text="0" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                  <Slider Grid.Column="1" Minimum="0" Maximum="50" Value="{Binding ImageEditor.Inpainting.MaskFeather}" TickFrequency="1"/>
                  <TextBlock Grid.Column="2" Text="{Binding ImageEditor.Inpainting.MaskFeatherText}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                </Grid>
                
                <!-- Denoise Strength -->
                <TextBlock Text="Denoise" FontSize="11" Opacity="0.7"/>
                <Grid ColumnDefinitions="35,*,50">
                  <TextBlock Grid.Column="0" Text="0" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                  <Slider Grid.Column="1" Minimum="0" Maximum="1" Value="{Binding ImageEditor.Inpainting.Denoise}" TickFrequency="0.05"/>
                  <TextBlock Grid.Column="2" Text="{Binding ImageEditor.Inpainting.DenoiseText}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                </Grid>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Action Buttons -->
                <Button Content="Clear Mask" Command="{Binding ImageEditor.Inpainting.ClearMaskCommand}" 
                        HorizontalAlignment="Stretch" Padding="6,4" FontSize="10"
                        ToolTip.Tip="Remove all painted mask areas"/>
                
                <Button Content="Generate" Command="{Binding ImageEditor.Inpainting.GenerateCommand}" 
                        HorizontalAlignment="Stretch" Padding="8,6" FontSize="12" FontWeight="SemiBold"
                        Background="#2D7D46" Foreground="White"
                        ToolTip.Tip="Send image and mask to ComfyUI for AI inpainting"/>
                
                <Button Content="Generate and Compare" Command="{Binding ImageEditor.Inpainting.GenerateAndCompareCommand}" 
                        HorizontalAlignment="Stretch" Padding="8,6" FontSize="11"
                        Background="#5E35B1" Foreground="White"
                        ToolTip.Tip="Generate inpainting and open before/after in Image Comparer"/>
                
                <!-- Progress (shown when busy) -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.Inpainting.IsBusy}">
                  <TextBlock Text="{Binding ImageEditor.Inpainting.Status}" 
                             FontSize="11" Opacity="0.8" TextWrapping="Wrap"/>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Workflow Info -->
                <Border Background="#1A2A1A" CornerRadius="4" Padding="6">
                  <TextBlock Text="Paint a mask over areas to regenerate, enter a prompt, then click Generate to send to ComfyUI." 
                             FontSize="9" Opacity="0.8" TextWrapping="Wrap" Foreground="#8BC34A"/>
                </Border>
              </StackPanel>
            </Border>
          </StackPanel>
        </StackPanel>
      </ScrollViewer>
    </Border>
  </Grid>
</UserControl>

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:DiffusionNexus.UI.ViewModels"
             xmlns:vmTabs="using:DiffusionNexus.UI.ViewModels.Tabs"
             xmlns:converters="using:DiffusionNexus.UI.Converters"
             xmlns:controls="using:DiffusionNexus.UI.Controls"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="DiffusionNexus.UI.Views.Tabs.ImageEditView"
             x:DataType="vmTabs:ImageEditTabViewModel">

  <UserControl.Resources>
    <converters:PathToBitmapConverter x:Key="PathToBitmapConverter"/>
  </UserControl.Resources>

  <Grid ColumnDefinitions="Auto,*,Auto">
    
    <!-- Left Side Panel - Image Thumbnails (Always visible) -->
    <Border Grid.Column="0" Width="120" Background="#1E1E1E" BorderBrush="#333" BorderThickness="0,0,1,0">
      <Grid RowDefinitions="Auto,Auto,*">
        <!-- Header with image count -->
        <Border Grid.Row="0" Background="#2A2A2A" Padding="8,6" BorderBrush="#333" BorderThickness="0,0,0,1">
          <StackPanel Spacing="2">
            <TextBlock Text="{Binding FilterStatusText}" FontSize="11" Opacity="0.7" HorizontalAlignment="Center"/>
            <!-- Show hint when no dataset selected -->
            <TextBlock Text="Select Dataset" FontSize="9" Opacity="0.5" HorizontalAlignment="Center"
                       IsVisible="{Binding SelectedEditorDataset, Converter={x:Static ObjectConverters.IsNull}}"/>
          </StackPanel>
        </Border>
        
        <!-- Rating Filters -->
        <Border Grid.Row="1" Background="#252525" Padding="4" BorderBrush="#333" BorderThickness="0,0,0,1">
          <StackPanel Orientation="Horizontal" Spacing="2" HorizontalAlignment="Center">
            <ToggleButton Content="+" IsChecked="{Binding ShowReady, Mode=TwoWay}" 
                          Padding="6,2" FontSize="11" FontWeight="Bold"
                          ToolTip.Tip="Show Ready/Production images"
                          Foreground="#4CAF50"/>
            <ToggleButton Content="-" IsChecked="{Binding ShowTrash, Mode=TwoWay}" 
                          Padding="6,2" FontSize="11" FontWeight="Bold"
                          ToolTip.Tip="Show Trash/Rejected images"
                          Foreground="#F44336"/>
            <ToggleButton Content="?" IsChecked="{Binding ShowUnrated, Mode=TwoWay}" 
                          Padding="6,2" FontSize="11" FontWeight="Bold"
                          ToolTip.Tip="Show Unrated images"
                          Foreground="#808080"/>
          </StackPanel>
        </Border>
        
        <!-- Image List -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
          <ItemsControl ItemsSource="{Binding FilteredEditorImages}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate><StackPanel Orientation="Vertical"/></ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:DatasetImageViewModel">
                <Button Command="{Binding $parent[ItemsControl].((vmTabs:ImageEditTabViewModel)DataContext).LoadEditorImageCommand}"
                        CommandParameter="{Binding}" Padding="0" Margin="4" Background="Transparent" BorderThickness="0"
                        Cursor="Hand" ToolTip.Tip="{Binding FullFileName}">
                  <Button.ContextMenu>
                    <ContextMenu>
                      <MenuItem Header="Rate: Production (+)" Command="{Binding MarkApprovedCommand}"/>
                      <MenuItem Header="Rate: Trash (-)" Command="{Binding MarkRejectedCommand}"/>
                      <Separator/>
                      <MenuItem Header="Clear Rating" Command="{Binding ClearRatingCommand}"/>
                    </ContextMenu>
                  </Button.ContextMenu>
                  <Grid Width="104" Height="78">
                    <Border Background="#2A2A2A" CornerRadius="4" ClipToBounds="True"
                            BorderBrush="{Binding IsEditorSelected, Converter={x:Static converters:BoolConverters.BoolToSelectionBorder}}"
                            BorderThickness="{Binding IsEditorSelected, Converter={x:Static converters:BoolConverters.BoolToSelectionThickness}}">
                      <Image Source="{Binding Thumbnail}" Stretch="UniformToFill"/>
                    </Border>
                    <!-- Rating Badge Overlay -->
                    <Border Width="18" Height="18" CornerRadius="2"
                            HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,2,2,0"
                            Background="{Binding RatingStatus, Converter={x:Static converters:BoolConverters.RatingStatusToBackground}}"
                            IsVisible="{Binding RatingStatus, Converter={x:Static converters:BoolConverters.RatingStatusToVisibility}}">
                      <TextBlock Text="{Binding RatingStatus, Converter={x:Static converters:BoolConverters.RatingStatusToSymbol}}"
                                 Foreground="White" FontWeight="Bold" FontSize="14"
                                 HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                  </Grid>
                </Button>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </Grid>
    </Border>
    
    <!-- Main Editor Area -->
    <Grid Grid.Column="1" RowDefinitions="Auto,*">
      <!-- Toolbar -->
      <Border Grid.Row="0" Background="#1E1E1E" Padding="16,8" BorderBrush="#333" BorderThickness="0,0,0,1">
        <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,*,Auto,Auto,Auto,Auto">
          <!-- Dataset and Version stacked vertically -->
          <StackPanel Grid.Column="0" Spacing="6" VerticalAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <TextBlock Text="Dataset:" VerticalAlignment="Center" Opacity="0.7" MinWidth="50"/>
              <ComboBox ItemsSource="{Binding EditorDatasets}" SelectedItem="{Binding SelectedEditorDataset, Mode=TwoWay}"
                        IsEditable="True" MinWidth="180" MaxWidth="250" PlaceholderText="Search datasets...">
                <ComboBox.ItemTemplate>
                  <DataTemplate x:DataType="vm:DatasetCardViewModel">
                    <TextBlock Text="{Binding Name}"/>
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="8">
              <TextBlock Text="Version:" VerticalAlignment="Center" Opacity="0.7" MinWidth="50"/>
              <ComboBox ItemsSource="{Binding EditorVersionItems}" SelectedItem="{Binding SelectedEditorVersion, Mode=TwoWay}" MinWidth="120"
                        IsEnabled="{Binding SelectedEditorDataset, Converter={x:Static ObjectConverters.IsNotNull}}">
                <ComboBox.ItemTemplate>
                  <DataTemplate x:DataType="vm:EditorVersionItem">
                    <TextBlock Text="{Binding DisplayText}" Foreground="#4CAF50"/>
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>
            </StackPanel>
          </StackPanel>
          <!-- Separator - always visible -->
          <Border Grid.Column="1" Width="1" Background="#444" Margin="16,4"/>
          <!-- Tool toggles - always visible but disabled when no image -->
          <StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="4">
            <ToggleButton Content="Crop" IsChecked="{Binding ImageEditor.IsCropToolActive, Mode=TwoWay}" Padding="12,6"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Color" IsChecked="{Binding ImageEditor.IsColorBalancePanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Color Balance"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="B/C" IsChecked="{Binding ImageEditor.IsBrightnessContrastPanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Brightness &amp; Contrast"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Rm BG" IsChecked="{Binding ImageEditor.IsBackgroundRemovalPanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Remove Background using AI (RMBG-1.4)"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Fill" IsChecked="{Binding ImageEditor.IsBackgroundFillPanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Fill transparent background with solid color"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Upscale" IsChecked="{Binding ImageEditor.IsUpscalingPanelOpen, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="AI Upscaling (4x-UltraSharp)"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
            <ToggleButton Content="Draw" IsChecked="{Binding ImageEditor.IsDrawingToolActive, Mode=TwoWay}" Padding="12,6" 
                          ToolTip.Tip="Drawing Tool - Hold Shift for straight lines"
                          IsEnabled="{Binding ImageEditor.HasImage}"/>
          </StackPanel>
          <!-- Separator - always visible -->
          <Border Grid.Column="6" Width="1" Background="#444" Margin="8,4"/>
          <!-- Transform buttons - always visible but disabled when no image -->
          <StackPanel Grid.Column="7" Orientation="Horizontal" Spacing="4">
            <Button Content="L" Command="{Binding ImageEditor.RotateLeftCommand}" Padding="10,6" ToolTip.Tip="Rotate Left 90�" FontSize="12" FontWeight="Bold"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
            <Button Content="R" Command="{Binding ImageEditor.RotateRightCommand}" Padding="10,6" ToolTip.Tip="Rotate Right 90�" FontSize="12" FontWeight="Bold"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
            <Button Content="180" Command="{Binding ImageEditor.Rotate180Command}" Padding="8,6" ToolTip.Tip="Rotate 180�" FontSize="11"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
            <Button Content="H" Command="{Binding ImageEditor.FlipHorizontalCommand}" Padding="10,6" ToolTip.Tip="Flip Horizontal" FontSize="12" FontWeight="Bold"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
            <Button Content="V" Command="{Binding ImageEditor.FlipVerticalCommand}" Padding="10,6" ToolTip.Tip="Flip Vertical" FontSize="12" FontWeight="Bold"
                    IsEnabled="{Binding ImageEditor.HasImage}"/>
          </StackPanel>
          <Border Grid.Column="8"/>
          <!-- Save buttons - hidden until image is loaded -->
          <StackPanel Grid.Column="9" Orientation="Horizontal" Spacing="4" IsVisible="{Binding ImageEditor.HasImage}">
            <Button Content="Save As New" Command="{Binding ImageEditor.SaveAsNewCommand}" Background="#2D7D46" Padding="12,6"/>
            <Button Content="Save" Command="{Binding ImageEditor.SaveOverwriteCommand}" Padding="12,6"/>
            <Button Content="Export" Command="{Binding ImageEditor.ExportCommand}" Padding="12,6" ToolTip.Tip="Export image to external location"/>
          </StackPanel>
          <!-- Separator before Reset/Clear - only visible when image is loaded -->
          <Border Grid.Column="10" Width="1" Background="#444" Margin="8,4" IsVisible="{Binding ImageEditor.HasImage}"/>
          <!-- Reset and Clear buttons - hidden until image is loaded -->
          <Button Grid.Column="11" Content="Reset" Command="{Binding ImageEditor.ResetImageCommand}" Margin="0,0,8,0" Padding="12,6"
                  IsVisible="{Binding ImageEditor.HasImage}"/>
          <Button Grid.Column="12" Content="Clear" Command="{Binding ImageEditor.ClearImageCommand}" Padding="12,6"
                  IsVisible="{Binding ImageEditor.HasImage}"/>
        </Grid>
      </Border>
      
      <!-- Image Editor Canvas -->
      <Border Grid.Row="1" Background="#1A1A1A" Margin="16">
        <Grid>
          <!-- Empty state - text instead of emoji -->
          <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" IsVisible="{Binding !ImageEditor.HasImage}">
            <Border Background="#333" CornerRadius="12" Padding="24">
              <TextBlock Text="No Image" FontSize="18" Opacity="0.4" HorizontalAlignment="Center"/>
            </Border>
            <TextBlock Text="No image loaded" FontSize="16" Opacity="0.4" HorizontalAlignment="Center" Margin="0,12,0,0"/>
            <TextBlock Text="Use 'Send to Image Edit' from Dataset Management" FontSize="12" Opacity="0.3" HorizontalAlignment="Center" Margin="0,4,0,0"/>
          </StackPanel>
          <controls:ImageEditorControl x:Name="ImageEditorCanvas"
                                       ImagePath="{Binding ImageEditor.CurrentImagePath}"
                                       IsCropToolActive="{Binding ImageEditor.IsCropToolActive}"
                                       IsDrawingToolActive="{Binding ImageEditor.IsDrawingToolActive}"
                                       IsVisible="{Binding ImageEditor.HasImage}"/>
        </Grid>
      </Border>
    </Grid>
    
    <!-- Right Side Panel - Info -->
    <Border Grid.Column="2" Width="200" Background="#1E1E1E" BorderBrush="#333" BorderThickness="1,0,0,0"
            IsVisible="{Binding ImageEditor.HasImage}">
      <ScrollViewer>
        <StackPanel Margin="12" Spacing="16">
          <!-- Filename Section -->
          <StackPanel Spacing="8">
            <TextBlock Text="File" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <TextBlock Text="{Binding ImageEditor.ImageFileName, FallbackValue='No image'}" 
                         FontSize="12" TextWrapping="Wrap" Opacity="0.9"/>
            </Border>
          </StackPanel>
          <StackPanel Spacing="8">
            <TextBlock Text="Information" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="4">
                <TextBlock FontSize="12" Opacity="0.8">
                  <Run Text="Size: "/><Run Text="{Binding ImageEditor.ImageWidth}"/><Run Text=" x "/><Run Text="{Binding ImageEditor.ImageHeight}"/><Run Text=" px"/>
                </TextBlock>
                <TextBlock Text="{Binding ImageEditor.ImageDpi, StringFormat='Resolution: {0} DPI'}" FontSize="12" Opacity="0.8"/>
                <TextBlock Text="{Binding ImageEditor.FileSizeText, StringFormat='File: {0}'}" FontSize="12" Opacity="0.8"/>
              </StackPanel>
            </Border>
          </StackPanel>
          <StackPanel Spacing="8">
            <TextBlock Text="Zoom" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="8">
                <TextBlock Text="{Binding ImageEditor.ZoomPercentageText}" FontSize="18" FontWeight="SemiBold" Foreground="#4CAF50" HorizontalAlignment="Center"/>
                <Slider Minimum="10" Maximum="500" Value="{Binding ImageEditor.ZoomPercentage}" x:Name="ZoomSlider"/>
                <Grid ColumnDefinitions="*,*">
                  <Button Grid.Column="0" Content="Fit" Command="{Binding ImageEditor.ZoomToFitCommand}" HorizontalAlignment="Stretch" Margin="0,0,2,0"/>
                  <Button Grid.Column="1" Content="100%" Command="{Binding ImageEditor.ZoomToActualCommand}" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Crop Tool Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.IsCropToolActive}">
            <TextBlock Text="Crop Tool" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="8">
                <TextBlock Text="Drag on the image to select the crop region." FontSize="11" Opacity="0.7" TextWrapping="Wrap"/>
                <Border Height="1" Background="#444" Margin="0,4"/>
                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*" Margin="0,4,0,0">
                  <Button Grid.Column="0" Content="Cancel" Command="{Binding ImageEditor.CancelCropCommand}" HorizontalAlignment="Stretch" Margin="0,0,2,0"/>
                  <Button Grid.Column="1" Content="Apply" Command="{Binding ImageEditor.ApplyCropCommand}" Background="#2D7D46" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Color Balance Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.IsColorBalancePanelOpen}">
            <TextBlock Text="Color Balance" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="10">
                <!-- Range Selection -->
                <TextBlock Text="Select Range" FontSize="11" Opacity="0.7"/>
                <StackPanel Spacing="4">
                  <RadioButton Content="Shadows" IsChecked="{Binding ImageEditor.IsShadowsSelected, Mode=TwoWay}" GroupName="ColorBalanceRange"/>
                  <RadioButton Content="Midtones" IsChecked="{Binding ImageEditor.IsMidtonesSelected, Mode=TwoWay}" GroupName="ColorBalanceRange"/>
                  <RadioButton Content="Highlights" IsChecked="{Binding ImageEditor.IsHighlightsSelected, Mode=TwoWay}" GroupName="ColorBalanceRange"/>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Cyan - Red -->
                <Grid ColumnDefinitions="50,*,40">
                  <TextBlock Grid.Column="0" Text="Cyan" FontSize="11" VerticalAlignment="Center" Foreground="#00FFFF"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.ColorBalanceCyanRed}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="Red" FontSize="11" VerticalAlignment="Center" HorizontalAlignment="Right" Foreground="#FF6666"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.ColorBalanceCyanRed, StringFormat='{}{0:F1}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <!-- Magenta - Green -->
                <Grid ColumnDefinitions="50,*,40">
                  <TextBlock Grid.Column="0" Text="Magenta" FontSize="11" VerticalAlignment="Center" Foreground="#FF00FF"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.ColorBalanceMagentaGreen}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="Green" FontSize="11" VerticalAlignment="Center" HorizontalAlignment="Right" Foreground="#66FF66"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.ColorBalanceMagentaGreen, StringFormat='{}{0:F1}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <!-- Yellow - Blue -->
                <Grid ColumnDefinitions="50,*,40">
                  <TextBlock Grid.Column="0" Text="Yellow" FontSize="11" VerticalAlignment="Center" Foreground="#FFFF00"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.ColorBalanceYellowBlue}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="Blue" FontSize="11" VerticalAlignment="Center" HorizontalAlignment="Right" Foreground="#6666FF"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.ColorBalanceYellowBlue, StringFormat='{}{0:F1}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Preserve Luminosity -->
                <CheckBox Content="Preserve Luminosity" IsChecked="{Binding ImageEditor.PreserveLuminosity}" FontSize="11"/>
                
                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*" Margin="0,4,0,0">
                  <Button Grid.Column="0" Content="Reset" Command="{Binding ImageEditor.ResetColorBalanceRangeCommand}" HorizontalAlignment="Stretch" Margin="0,0,2,0"/>
                  <Button Grid.Column="1" Content="Apply" Command="{Binding ImageEditor.ApplyColorBalanceCommand}" Background="#2D7D46" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Brightness/Contrast Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.IsBrightnessContrastPanelOpen}">
            <TextBlock Text="Brightness/Contrast" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="10">
                <!-- Brightness -->
                <TextBlock Text="Brightness" FontSize="11" Opacity="0.7"/>
                <Grid ColumnDefinitions="40,*,40">
                  <TextBlock Grid.Column="0" Text="-" FontSize="16" VerticalAlignment="Center" Opacity="0.5" HorizontalAlignment="Center"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.Brightness}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="+" FontSize="16" VerticalAlignment="Center" Opacity="0.5" HorizontalAlignment="Center"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.Brightness, StringFormat='{}{0:F0}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <!-- Contrast -->
                <TextBlock Text="Contrast" FontSize="11" Opacity="0.7"/>
                <Grid ColumnDefinitions="40,*,40">
                  <TextBlock Grid.Column="0" Text="-" FontSize="16" VerticalAlignment="Center" Opacity="0.5" HorizontalAlignment="Center"/>
                  <Slider Grid.Column="1" Minimum="-100" Maximum="100" Value="{Binding ImageEditor.Contrast}" TickFrequency="10"/>
                  <TextBlock Grid.Column="2" Text="+" FontSize="16" VerticalAlignment="Center" Opacity="0.5" HorizontalAlignment="Center"/>
                </Grid>
                <TextBlock Text="{Binding ImageEditor.Contrast, StringFormat='{}{0:F0}'}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*" Margin="0,4,0,0">
                  <Button Grid.Column="0" Content="Reset" Command="{Binding ImageEditor.ResetBrightnessContrastCommand}" HorizontalAlignment="Stretch" Margin="0,0,2,0"/>
                  <Button Grid.Column="1" Content="Apply" Command="{Binding ImageEditor.ApplyBrightnessContrastCommand}" Background="#2D7D46" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Background Removal Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.IsBackgroundRemovalPanelOpen}">
            <TextBlock Text="Background Removal" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="8">
                <!-- Model Status -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Model Status" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Border Width="8" Height="8" CornerRadius="4"
                            Background="{Binding ImageEditor.IsBackgroundRemovalModelReady, Converter={x:Static converters:BoolConverters.BoolToStatusBrush}}"/>
                    <TextBlock FontSize="12" Opacity="0.9"
                               Text="{Binding ImageEditor.IsBackgroundRemovalModelReady, Converter={x:Static converters:BoolConverters.BoolToModelStatusText}}"/>
                  </StackPanel>
                </StackPanel>
                
                <!-- Download Button (shown when model missing and not busy) -->
                <Button Content="Download Model (~176 MB)" 
                        Command="{Binding ImageEditor.DownloadBackgroundRemovalModelCommand}"
                        HorizontalAlignment="Stretch"
                        Background="#5E35B1"
                        Foreground="White"
                        IsVisible="{Binding ImageEditor.IsBackgroundRemovalModelMissing}"
                        IsEnabled="{Binding !ImageEditor.IsBackgroundRemovalBusy}"/>
                
                <!-- Progress (shown when busy) -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.IsBackgroundRemovalBusy}">
                  <TextBlock Text="{Binding ImageEditor.BackgroundRemovalStatus}" 
                             FontSize="11" Opacity="0.8" TextWrapping="Wrap"/>
                  <Border Background="#333" CornerRadius="2" Height="6" Margin="0,2,0,0">
                    <Border Background="#5E35B1" CornerRadius="2" HorizontalAlignment="Left"
                            Width="{Binding ImageEditor.BackgroundRemovalProgress, Converter={x:Static converters:BoolConverters.PercentageToWidth}}"/>
                  </Border>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Instructions -->
                <TextBlock Text="Uses RMBG-1.4 AI model to remove backgrounds. Runs locally on GPU/CPU." 
                           FontSize="10" Opacity="0.6" TextWrapping="Wrap"/>
                <TextBlock Text="{Binding ImageEditor.IsBackgroundRemovalModelReady, Converter={x:Static converters:BoolConverters.BoolToModelPathText}}"
                           FontSize="9" Opacity="0.4" TextWrapping="Wrap"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Action Buttons -->
                <Button Content="Apply" Command="{Binding ImageEditor.RemoveBackgroundCommand}" 
                        Background="#2D7D46" HorizontalAlignment="Stretch"
                        IsEnabled="{Binding ImageEditor.IsBackgroundRemovalModelReady}"/>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Background Fill Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.IsBackgroundFillPanelOpen}">
            <TextBlock Text="Background Fill" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="10">
                <!-- Color Preview -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Fill Color" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="Auto,*">
                    <Border Grid.Column="0" Width="32" Height="32" CornerRadius="4" BorderBrush="#555" BorderThickness="1" Margin="0,0,8,0">
                      <Border.Background>
                        <SolidColorBrush Color="{Binding ImageEditor.BackgroundFillColor}"/>
                      </Border.Background>
                    </Border>
                    <TextBlock Grid.Column="1" Text="{Binding ImageEditor.BackgroundFillColorHex}" 
                               VerticalAlignment="Center" FontSize="12" FontFamily="Consolas" Opacity="0.9"/>
                  </Grid>
                </StackPanel>
                
                <!-- Preset Colors -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Presets" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="White"
                            Command="{Binding ImageEditor.SetBackgroundFillPresetCommand}" CommandParameter="White">
                      <Border Width="24" Height="24" CornerRadius="2" Background="White"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Black"
                            Command="{Binding ImageEditor.SetBackgroundFillPresetCommand}" CommandParameter="Black">
                      <Border Width="24" Height="24" CornerRadius="2" Background="Black" BorderBrush="#555" BorderThickness="1"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Gray"
                            Command="{Binding ImageEditor.SetBackgroundFillPresetCommand}" CommandParameter="Gray">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#808080"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Green"
                            Command="{Binding ImageEditor.SetBackgroundFillPresetCommand}" CommandParameter="Green">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#00B140"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Blue"
                            Command="{Binding ImageEditor.SetBackgroundFillPresetCommand}" CommandParameter="Blue">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#0078D7"/>
                    </Button>
                  </StackPanel>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- RGB Sliders -->
                <StackPanel Spacing="6">
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="R" FontSize="11" VerticalAlignment="Center" Foreground="#FF6666" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.BackgroundFillRed}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.BackgroundFillRed}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="G" FontSize="11" VerticalAlignment="Center" Foreground="#66FF66" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.BackgroundFillGreen}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.BackgroundFillGreen}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="B" FontSize="11" VerticalAlignment="Center" Foreground="#6666FF" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.BackgroundFillBlue}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.BackgroundFillBlue}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Action Button -->
                <Button Content="Apply Fill" Command="{Binding ImageEditor.ApplyBackgroundFillCommand}" 
                        Background="#2D7D46" HorizontalAlignment="Stretch"/>
                        
                <!-- Instructions -->
                <TextBlock Text="Fills transparent areas with the selected color. Use after removing background." 
                           FontSize="10" Opacity="0.5" TextWrapping="Wrap" Margin="0,4,0,0"/>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- AI Upscaling Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.IsUpscalingPanelOpen}">
            <TextBlock Text="AI Upscaling" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="8">
                <!-- Model Status -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Model Status" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Border Width="8" Height="8" CornerRadius="4"
                            Background="{Binding ImageEditor.IsUpscalingModelReady, Converter={x:Static converters:BoolConverters.BoolToStatusBrush}}"/>
                    <TextBlock FontSize="12" Opacity="0.9"
                               Text="{Binding ImageEditor.IsUpscalingModelReady, Converter={x:Static converters:BoolConverters.BoolToUpscalingModelStatusText}}"/>
                  </StackPanel>
                </StackPanel>
                
                <!-- Download Button (shown when model missing and not busy) -->
                <Button Content="Download Model (~67 MB)" 
                        Command="{Binding ImageEditor.DownloadUpscalingModelCommand}"
                        HorizontalAlignment="Stretch"
                        Background="#5E35B1"
                        Foreground="White"
                        IsVisible="{Binding ImageEditor.IsUpscalingModelMissing}"
                        IsEnabled="{Binding !ImageEditor.IsUpscalingBusy}"/>
                
                <!-- Progress (shown when busy) -->
                <StackPanel Spacing="4" IsVisible="{Binding ImageEditor.IsUpscalingBusy}">
                  <TextBlock Text="{Binding ImageEditor.UpscalingStatus}" 
                             FontSize="11" Opacity="0.8" TextWrapping="Wrap"/>
                  <Border Background="#333" CornerRadius="2" Height="6" Margin="0,2,0,0">
                    <Border Background="#5E35B1" CornerRadius="2" HorizontalAlignment="Left"
                            Width="{Binding ImageEditor.UpscalingProgress, Converter={x:Static converters:BoolConverters.PercentageToWidth}}"/>
                  </Border>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Scale Slider (only show when model is ready) -->
                <StackPanel Spacing="6" IsVisible="{Binding ImageEditor.IsUpscalingModelReady}">
                  <TextBlock Text="Target Scale" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="Auto,*,Auto">
                    <TextBlock Grid.Column="0" Text="1.1x" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                    <Slider Grid.Column="1" Minimum="1.1" Maximum="4.0" Value="{Binding ImageEditor.UpscaleTargetScale}" 
                            TickFrequency="0.1" Margin="8,0"/>
                    <TextBlock Grid.Column="2" Text="4.0x" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                  </Grid>
                  <TextBlock Text="{Binding ImageEditor.UpscaleTargetScaleText}" 
                             FontSize="18" FontWeight="SemiBold" Foreground="#5E35B1" HorizontalAlignment="Center"/>
                  
                  <!-- Output Dimensions Preview -->
                  <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="4" Margin="0,4,0,0">
                    <TextBlock Text="Output:" FontSize="10" Opacity="0.6"/>
                    <TextBlock Text="{Binding ImageEditor.UpscaleOutputDimensions}" FontSize="10" Opacity="0.8"/>
                  </StackPanel>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Instructions -->
                <TextBlock Text="Uses 4x-UltraSharp AI model for high-quality upscaling. Runs locally on GPU/CPU." 
                           FontSize="10" Opacity="0.6" TextWrapping="Wrap"/>
                
                <!-- Performance Warning -->
                <Border Background="#3D2D00" CornerRadius="4" Padding="6" Margin="0,4,0,0" 
                        IsVisible="{Binding ImageEditor.IsUpscalingModelReady}">
                  <TextBlock Text="? Processing can take several minutes for large images. A 4x upscale is always computed internally, even for lower target scales." 
                             FontSize="9" Opacity="0.9" TextWrapping="Wrap" Foreground="#FFCC00"/>
                </Border>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Action Button -->
                <Button Content="Apply Upscale" Command="{Binding ImageEditor.UpscaleImageCommand}" 
                        Background="#2D7D46" HorizontalAlignment="Stretch"
                        IsEnabled="{Binding ImageEditor.IsUpscalingModelReady}"/>
              </StackPanel>
            </Border>
          </StackPanel>
          
          <!-- Drawing Tool Panel -->
          <StackPanel Spacing="8" IsVisible="{Binding ImageEditor.IsDrawingToolActive}">
            <TextBlock Text="Drawing Tool" FontWeight="SemiBold" FontSize="14"/>
            <Border Background="#2A2A2A" CornerRadius="4" Padding="8">
              <StackPanel Spacing="10">
                <!-- Instructions -->
                <TextBlock Text="Click and drag to draw. Hold Shift for straight lines." 
                           FontSize="10" Opacity="0.6" TextWrapping="Wrap"/>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Color Preview -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Brush Color" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="Auto,*">
                    <Border Grid.Column="0" Width="32" Height="32" CornerRadius="4" BorderBrush="#555" BorderThickness="1" Margin="0,0,8,0">
                      <Border.Background>
                        <SolidColorBrush Color="{Binding ImageEditor.DrawingBrushColor}"/>
                      </Border.Background>
                    </Border>
                    <TextBlock Grid.Column="1" Text="{Binding ImageEditor.DrawingBrushColorHex}" 
                               VerticalAlignment="Center" FontSize="12" FontFamily="Consolas" Opacity="0.9"/>
                  </Grid>
                </StackPanel>
                
                <!-- Preset Colors -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Presets" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="White"
                            Command="{Binding ImageEditor.SetDrawingColorPresetCommand}" CommandParameter="White">
                      <Border Width="24" Height="24" CornerRadius="2" Background="White"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Black"
                            Command="{Binding ImageEditor.SetDrawingColorPresetCommand}" CommandParameter="Black">
                      <Border Width="24" Height="24" CornerRadius="2" Background="Black" BorderBrush="#555" BorderThickness="1"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Red"
                            Command="{Binding ImageEditor.SetDrawingColorPresetCommand}" CommandParameter="Red">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#FF0000"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Green"
                            Command="{Binding ImageEditor.SetDrawingColorPresetCommand}" CommandParameter="Green">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#00FF00"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Blue"
                            Command="{Binding ImageEditor.SetDrawingColorPresetCommand}" CommandParameter="Blue">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#0000FF"/>
                    </Button>
                    <Button Width="28" Height="28" Padding="0" ToolTip.Tip="Yellow"
                            Command="{Binding ImageEditor.SetDrawingColorPresetCommand}" CommandParameter="Yellow">
                      <Border Width="24" Height="24" CornerRadius="2" Background="#FFFF00"/>
                    </Button>
                  </StackPanel>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- RGB Sliders -->
                <StackPanel Spacing="6">
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="R" FontSize="11" VerticalAlignment="Center" Foreground="#FF6666" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingBrushRed}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingBrushRed}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="G" FontSize="11" VerticalAlignment="Center" Foreground="#66FF66" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingBrushGreen}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingBrushGreen}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                  <Grid ColumnDefinitions="30,*,35">
                    <TextBlock Grid.Column="0" Text="B" FontSize="11" VerticalAlignment="Center" Foreground="#6666FF" FontWeight="Bold"/>
                    <Slider Grid.Column="1" Minimum="0" Maximum="255" Value="{Binding ImageEditor.DrawingBrushBlue}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingBrushBlue}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Brush Size -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Brush Size" FontSize="11" Opacity="0.7"/>
                  <Grid ColumnDefinitions="35,*,50">
                    <TextBlock Grid.Column="0" Text="1" FontSize="10" VerticalAlignment="Center" Opacity="0.5"/>
                    <Slider Grid.Column="1" Minimum="1" Maximum="100" Value="{Binding ImageEditor.DrawingBrushSize}" TickFrequency="1"/>
                    <TextBlock Grid.Column="2" Text="{Binding ImageEditor.DrawingBrushSizeText}" FontSize="10" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.7"/>
                  </Grid>
                </StackPanel>
                
                <Border Height="1" Background="#444" Margin="0,4"/>
                
                <!-- Brush Shape -->
                <StackPanel Spacing="4">
                  <TextBlock Text="Brush Shape" FontSize="11" Opacity="0.7"/>
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <RadioButton Content="Round" IsChecked="{Binding ImageEditor.IsRoundBrush, Mode=TwoWay}" GroupName="BrushShape"/>
                    <RadioButton Content="Square" IsChecked="{Binding ImageEditor.IsSquareBrush, Mode=TwoWay}" GroupName="BrushShape"/>
                  </StackPanel>
                </StackPanel>
              </StackPanel>
            </Border>
          </StackPanel>
        </StackPanel>
      </ScrollViewer>
    </Border>
  </Grid>
</UserControl>

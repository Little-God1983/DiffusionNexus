<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:DiffusionNexus.UI.ViewModels"
        xmlns:enums="using:DiffusionNexus.Domain.Enums"
        x:Class="DiffusionNexus.UI.Views.Dialogs.CaptioningDialog"
        x:DataType="vm:CaptioningViewModel"
        Width="600"
        Height="700"
        WindowStartupLocation="CenterOwner"
        CanResize="False"
        Background="#252526"
        Title="AI Auto Captioning">

  <ScrollViewer>
    <Grid Margin="24" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto">

      <!-- Header -->
      <StackPanel Grid.Row="0" Margin="0,0,0,20">
        <TextBlock Text="AI Auto Captioning"
                   FontSize="20"
                   FontWeight="SemiBold"
                   Foreground="#D4A574" />
        <TextBlock Text="Generate captions for your datasets using local LLMs."
                   FontSize="12"
                   Opacity="0.7"
                   Margin="0,4,0,0" />
      </StackPanel>

      <!-- Model Selection -->
      <Border Grid.Row="1" Background="#333333" CornerRadius="8" Padding="16" Margin="0,0,0,16">
        <StackPanel Spacing="12">
          <TextBlock Text="Model Selection" FontWeight="SemiBold" FontSize="14" />
          
          <ComboBox ItemsSource="{Binding AvailableModels}"
                    SelectedItem="{Binding SelectedModelType}"
                    HorizontalAlignment="Stretch" />

          <!-- Llava Status/Download -->
          <Grid ColumnDefinitions="*, Auto" IsVisible="{Binding SelectedModelType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static enums:CaptioningModelType.LLaVA_v1_6_34B}}">
            <StackPanel Grid.Column="0" VerticalAlignment="Center">
              <TextBlock Text="LLaVA v1.6 34B" FontWeight="Bold" />
              <TextBlock Text="{Binding LlavaStatus}" FontSize="12" Opacity="0.7" />
              <ProgressBar Value="{Binding LlavaDownloadProgress}" Maximum="100" Height="2" Margin="0,4,8,0" 
                           IsVisible="{Binding IsLlavaDownloading}" />
            </StackPanel>
            <Button Grid.Column="1" Content="Download" 
                    Command="{Binding DownloadModelCommand}" 
                    CommandParameter="{x:Static enums:CaptioningModelType.LLaVA_v1_6_34B}"
                    IsVisible="{Binding IsLlavaMissing}" />
            <TextBlock Grid.Column="1" Text="Ready" Foreground="#4CAF50" VerticalAlignment="Center" FontWeight="Bold"
                       IsVisible="{Binding IsLlavaReady}" />
          </Grid>

          <!-- Qwen Status/Download -->
          <Grid ColumnDefinitions="*, Auto" IsVisible="{Binding SelectedModelType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static enums:CaptioningModelType.Qwen2_5_VL_7B}}">
            <StackPanel Grid.Column="0" VerticalAlignment="Center">
              <TextBlock Text="Qwen 2.5 VL 7B" FontWeight="Bold" />
              <TextBlock Text="{Binding QwenStatus}" FontSize="12" Opacity="0.7" />
              <ProgressBar Value="{Binding QwenDownloadProgress}" Maximum="100" Height="2" Margin="0,4,8,0" 
                           IsVisible="{Binding IsQwenDownloading}" />
            </StackPanel>
            <Button Grid.Column="1" Content="Download" 
                    Command="{Binding DownloadModelCommand}" 
                    CommandParameter="{x:Static enums:CaptioningModelType.Qwen2_5_VL_7B}"
                    IsVisible="{Binding IsQwenMissing}" />
            <TextBlock Grid.Column="1" Text="Ready" Foreground="#4CAF50" VerticalAlignment="Center" FontWeight="Bold"
                       IsVisible="{Binding IsQwenReady}" />
          </Grid>
        </StackPanel>
      </Border>

      <!-- Input Selection -->
      <Border Grid.Row="2" Background="#333333" CornerRadius="8" Padding="16" Margin="0,0,0,16">
        <StackPanel Spacing="12">
          <TextBlock Text="Input Source" FontWeight="SemiBold" FontSize="14" />
          
          <ToggleSwitch IsChecked="{Binding IsSingleImageMode}" 
                        OnContent="Single Image" 
                        OffContent="Dataset" 
                        HorizontalAlignment="Left" />

          <!-- Dataset Input -->
          <StackPanel IsVisible="{Binding !IsSingleImageMode}">
            <TextBlock Text="Select Dataset" Margin="0,0,0,4" />
            <Grid ColumnDefinitions="*, 12, Auto">
              <ComboBox Grid.Column="0" 
                        ItemsSource="{Binding AvailableDatasets}"
                        SelectedItem="{Binding SelectedDataset}"
                        PlaceholderText="Choose a dataset..."
                        HorizontalAlignment="Stretch">
                <ComboBox.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding Name}" />
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>

              <ComboBox Grid.Column="2"
                        ItemsSource="{Binding AvailableDatasetVersions}"
                        SelectedItem="{Binding SelectedDatasetVersion}"
                        MinWidth="80"
                        ToolTip.Tip="Select Version"
                        IsEnabled="{Binding SelectedDataset, Converter={x:Static ObjectConverters.IsNotNull}}">
                <ComboBox.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding StringFormat='V{0}'}" />
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>
            </Grid>
          </StackPanel>

          <!-- Single Image Input -->
          <StackPanel IsVisible="{Binding IsSingleImageMode}" Spacing="8">
            <TextBlock Text="Single Image" />
            <Grid ColumnDefinitions="*, Auto, Auto">
              <TextBox Grid.Column="0" Text="{Binding SingleImagePath}" IsReadOnly="True" Watermark="No image selected" VerticalAlignment="Center" />
              <Button Grid.Column="1" Content="..." Command="{Binding SelectSingleImageCommand}" Margin="4,0,0,0" />
              <Button Grid.Column="2" Content="X" Command="{Binding ClearSingleImageCommand}" Margin="4,0,0,0" />
            </Grid>
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- Settings -->
      <Border Grid.Row="3" Background="#333333" CornerRadius="8" Padding="16" Margin="0,0,0,16">
        <StackPanel Spacing="12">
          <TextBlock Text="Captioning Settings" FontWeight="SemiBold" FontSize="14" />

          <Grid ColumnDefinitions="*, 16, *" RowDefinitions="Auto, Auto, Auto, Auto">
            
            <!-- System Prompt -->
            <StackPanel Grid.Row="0" Grid.ColumnSpan="3" Margin="0,0,0,12">
              <TextBlock Text="System Prompt" Margin="0,0,0,4" />
              <TextBox Text="{Binding SystemPrompt}" AcceptsReturn="True" Height="60" TextWrapping="Wrap" />
            </StackPanel>

            <!-- Trigger Word -->
            <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,0,12">
              <TextBlock Text="Trigger Word (Optional)" Margin="0,0,0,4" />
              <TextBox Text="{Binding TriggerWord}" Watermark="e.g. ohwx style" />
            </StackPanel>

            <!-- Blacklisted Words -->
            <StackPanel Grid.Row="1" Grid.Column="2" Margin="0,0,0,12">
              <TextBlock Text="Blacklisted Words (Optional, comma sep)" Margin="0,0,0,4" />
              <TextBox Text="{Binding BlacklistedWords}" Watermark="text, watermark, signature" />
            </StackPanel>

            <!-- Temperature -->
            <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,0,12">
              <TextBlock Text="{Binding Temperature, StringFormat='Temperature: {0:F1}'}" Margin="0,0,0,4" />
              <Slider Value="{Binding Temperature}" Minimum="0.1" Maximum="2.0" TickFrequency="0.1" IsSnapToTickEnabled="True" />
            </StackPanel>
            
            <!-- Override Option -->
            <StackPanel Grid.Row="2" Grid.Column="2" VerticalAlignment="Center">
              <CheckBox Content="Override Existing Captions" IsChecked="{Binding OverrideExisting}" />
            </StackPanel>
            
          </Grid>
        </StackPanel>
      </Border>

      <!-- Processing/Status -->
      <StackPanel Grid.Row="4" Spacing="8" Margin="0,0,0,16">
        <StackPanel IsVisible="{Binding IsProcessing}">
             <TextBlock Text="{Binding CurrentProcessingStatus}" HorizontalAlignment="Center" />
             <ProgressBar Value="{Binding TotalProgress}" Maximum="100" Height="4" />
        </StackPanel>
        
        <TextBlock Text="{Binding StatusMessage}" 
                   Foreground="#D4A574" 
                   TextWrapping="Wrap" 
                   HorizontalAlignment="Center" />
      </StackPanel>

      <!-- Footer Buttons -->
      <StackPanel Grid.Row="5" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="12">
        <Button Content="Close" Click="OnCloseClick" IsEnabled="{Binding !IsProcessing}" />
        <Button Content="Generate Captions" 
                Command="{Binding GenerateCommand}" 
                Background="#2D7D46" 
                Foreground="White"
                FontWeight="Bold" 
                Padding="16,8" />
      </StackPanel>

    </Grid>
  </ScrollViewer>
</Window>

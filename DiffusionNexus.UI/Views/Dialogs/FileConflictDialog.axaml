<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="using:DiffusionNexus.UI.Views.Dialogs"
        xmlns:vm="using:DiffusionNexus.UI.ViewModels"
        x:Class="DiffusionNexus.UI.Views.Dialogs.FileConflictDialog"
        x:DataType="vm:FileConflictDialogViewModel"
        Title="Resolve File Conflicts"
        Width="1100"
        Height="700"
        MinWidth="900"
        MinHeight="500"
        WindowStartupLocation="CenterOwner"
        Background="#252526">

  <Grid Margin="24" RowDefinitions="Auto,Auto,*,Auto,Auto,Auto">

    <!-- Header -->
    <StackPanel Grid.Row="0" Margin="0,0,0,16">
      <TextBlock Text="File Conflicts Detected"
                 FontSize="20"
                 FontWeight="Bold"
                 Foreground="#D4A574"
                 Margin="0,0,0,8"/>
      <TextBlock Text="{Binding HeaderText}"
                 FontSize="14"
                 Opacity="0.8"/>
    </StackPanel>

    <!-- Bulk Actions (only show if there are conflicts) -->
    <Border Grid.Row="1"
            Background="#1E1E1E"
            CornerRadius="6"
            Padding="12"
            Margin="0,0,0,16"
            IsVisible="{Binding HasConflicts}">
      <StackPanel Orientation="Horizontal" Spacing="16">
        <TextBlock Text="Apply to all:"
                   VerticalAlignment="Center"
                   FontWeight="SemiBold"/>
        <Button Content="Override All"
                Command="{Binding SetAllOverrideCommand}"
                Padding="12,6"
                Background="#7D4D2D"/>
        <Button Content="Rename All"
                Command="{Binding SetAllRenameCommand}"
                Padding="12,6"
                Background="#2D5D7D"/>
        <Button Content="Ignore All"
                Command="{Binding SetAllIgnoreCommand}"
                Padding="12,6"
                Background="#4D4D4D"/>
      </StackPanel>
    </Border>

    <!-- Conflict Table -->
    <Border Grid.Row="2"
            Background="#1E1E1E"
            CornerRadius="8"
            IsVisible="{Binding HasConflicts}">
      <ScrollViewer HorizontalScrollBarVisibility="Auto"
                    VerticalScrollBarVisibility="Auto">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
          </Grid.RowDefinitions>

          <!-- Table Header -->
          <Border Grid.Row="0"
                  Background="#333"
                  Padding="8,10">
            <Grid ColumnDefinitions="60,80,90,*,60,80,90,100,100,80">
              <TextBlock Grid.Column="0" Text="Preview" FontWeight="SemiBold" HorizontalAlignment="Center"/>
              <TextBlock Grid.Column="1" Text="Size" FontWeight="SemiBold" HorizontalAlignment="Center"/>
              <TextBlock Grid.Column="2" Text="Date" FontWeight="SemiBold" HorizontalAlignment="Center"/>
              <TextBlock Grid.Column="3" Text="Filename" FontWeight="SemiBold" HorizontalAlignment="Center" Foreground="#FFD700"/>
              <TextBlock Grid.Column="4" Text="Preview" FontWeight="SemiBold" HorizontalAlignment="Center"/>
              <TextBlock Grid.Column="5" Text="Size" FontWeight="SemiBold" HorizontalAlignment="Center"/>
              <TextBlock Grid.Column="6" Text="Date" FontWeight="SemiBold" HorizontalAlignment="Center"/>
              <TextBlock Grid.Column="7" Text="Override" FontWeight="SemiBold" HorizontalAlignment="Center" Foreground="#D9A54B"/>
              <TextBlock Grid.Column="8" Text="Rename" FontWeight="SemiBold" HorizontalAlignment="Center" Foreground="#5DA5D9"/>
              <TextBlock Grid.Column="9" Text="Ignore" FontWeight="SemiBold" HorizontalAlignment="Center" Foreground="#888"/>
            </Grid>
          </Border>

          <!-- Sub-header row for Existing/New labels -->
          <Border Grid.Row="0"
                  Margin="0,36,0,0"
                  Padding="8,4"
                  Background="#2A2A2A">
            <Grid ColumnDefinitions="60,80,90,*,60,80,90,100,100,80">
              <TextBlock Grid.Column="0" Grid.ColumnSpan="3" 
                         Text="Existing File" 
                         FontSize="11" 
                         Opacity="0.6"
                         HorizontalAlignment="Left"
                         Margin="4,0,0,0"/>
              <TextBlock Grid.Column="4" Grid.ColumnSpan="3" 
                         Text="New File" 
                         FontSize="11" 
                         Opacity="0.6"
                         HorizontalAlignment="Left"
                         Margin="4,0,0,0"/>
              <TextBlock Grid.Column="7" Grid.ColumnSpan="3" 
                         Text="Action" 
                         FontSize="11" 
                         Opacity="0.6"
                         HorizontalAlignment="Center"/>
            </Grid>
          </Border>

          <!-- Conflict Items -->
          <ItemsControl Grid.Row="1"
                        ItemsSource="{Binding Conflicts}"
                        Margin="0,24,0,0">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:FileConflictItem">
                <Border Padding="8,6"
                        BorderBrush="#444"
                        BorderThickness="0,0,0,1">
                  <Grid ColumnDefinitions="60,80,90,*,60,80,90,100,100,80">
                    
                    <!-- Existing File Preview -->
                    <Border Grid.Column="0"
                            Width="50" Height="50"
                            Background="#333"
                            CornerRadius="4"
                            ClipToBounds="True"
                            HorizontalAlignment="Center">
                      <Image Source="{Binding ExistingPreview}"
                             Stretch="UniformToFill"
                             IsVisible="{Binding IsImage}"/>
                    </Border>

                    <!-- Existing File Size -->
                    <TextBlock Grid.Column="1"
                               Text="{Binding ExistingFileSizeText}"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Center"
                               FontSize="12"/>

                    <!-- Existing File Date -->
                    <TextBlock Grid.Column="2"
                               Text="{Binding ExistingCreationDateText}"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Center"
                               FontSize="12"
                               Opacity="0.8"/>

                    <!-- Conflicting Filename -->
                    <StackPanel Grid.Column="3"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center">
                      <TextBlock Text="{Binding ConflictingName}"
                                 FontWeight="SemiBold"
                                 Foreground="#FFD700"
                                 TextTrimming="CharacterEllipsis"
                                 HorizontalAlignment="Center"
                                 ToolTip.Tip="{Binding ConflictingName}"/>
                      <TextBlock Text="+ caption"
                                 FontSize="10"
                                 Opacity="0.6"
                                 HorizontalAlignment="Center"
                                 IsVisible="{Binding HasPairedCaption}"/>
                    </StackPanel>

                    <!-- New File Preview -->
                    <Border Grid.Column="4"
                            Width="50" Height="50"
                            Background="#333"
                            CornerRadius="4"
                            ClipToBounds="True"
                            HorizontalAlignment="Center">
                      <Image Source="{Binding NewPreview}"
                             Stretch="UniformToFill"
                             IsVisible="{Binding IsImage}"/>
                    </Border>

                    <!-- New File Size -->
                    <TextBlock Grid.Column="5"
                               Text="{Binding NewFileSizeText}"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Center"
                               FontSize="12"/>

                    <!-- New File Date -->
                    <TextBlock Grid.Column="6"
                               Text="{Binding NewCreationDateText}"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Center"
                               FontSize="12"
                               Opacity="0.8"/>

                    <!-- Override Radio -->
                    <RadioButton Grid.Column="7"
                                 IsChecked="{Binding IsOverride}"
                                 GroupName="{Binding ConflictingName}"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"/>

                    <!-- Rename Radio -->
                    <RadioButton Grid.Column="8"
                                 IsChecked="{Binding IsRename}"
                                 GroupName="{Binding ConflictingName}"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"/>

                    <!-- Ignore Radio -->
                    <RadioButton Grid.Column="9"
                                 IsChecked="{Binding IsIgnore}"
                                 GroupName="{Binding ConflictingName}"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"/>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </Grid>
      </ScrollViewer>
    </Border>

    <!-- Non-Conflicting Files Section -->
    <Border Grid.Row="3"
            Background="#1E2E1E"
            BorderBrush="#2D4D2D"
            BorderThickness="2"
            CornerRadius="8"
            Padding="12"
            Margin="0,8,0,0"
            MaxHeight="150"
            IsVisible="{Binding HasNonConflictingFiles}">
      <Grid RowDefinitions="Auto,*">
        <!-- Section Header -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
          <TextBlock Text="? "
                     FontSize="14"
                     Foreground="#4CAF50"
                     VerticalAlignment="Center"/>
          <TextBlock Text="{Binding NonConflictingCount, StringFormat='{}{0} new files will be added'}"
                     FontSize="13"
                     FontWeight="SemiBold"
                     Foreground="#4CAF50"
                     VerticalAlignment="Center"/>
        </StackPanel>
        
        <!-- Non-Conflicting Files List -->
        <ScrollViewer Grid.Row="1" 
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
          <ItemsControl ItemsSource="{Binding NonConflictingFiles}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <WrapPanel Orientation="Horizontal"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:NonConflictingFileItem">
                <Border Background="#2A3A2A" 
                        CornerRadius="4" 
                        Padding="8,4" 
                        Margin="2">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="{Binding FileName}"
                               FontSize="11"
                               VerticalAlignment="Center"
                               MaxWidth="200"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding FileName}"/>
                    <TextBlock Text="{Binding FileSizeText}"
                               FontSize="10"
                               Opacity="0.6"
                               VerticalAlignment="Center"/>
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </Grid>
    </Border>

    <!-- Summary -->
    <Border Grid.Row="4"
            Background="#2D4D2D"
            CornerRadius="6"
            Padding="12"
            Margin="0,16,0,0">
      <TextBlock Text="{Binding SummaryText}"
                 FontWeight="SemiBold"
                 HorizontalAlignment="Center"/>
    </Border>

    <!-- Buttons -->
    <StackPanel Grid.Row="5"
                Orientation="Horizontal"
                HorizontalAlignment="Right"
                Spacing="12"
                Margin="0,16,0,0">
      <Button Content="Cancel"
              Width="100"
              Padding="12,8"
              Click="OnCancelClick"/>
      <Button Content="Apply"
              Width="100"
              Padding="12,8"
              IsDefault="True"
              Background="#2D7D46"
              Click="OnApplyClick"/>
    </StackPanel>

  </Grid>
</Window>

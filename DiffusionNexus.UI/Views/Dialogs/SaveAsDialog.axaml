<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="using:DiffusionNexus.UI.Views.Dialogs"
        xmlns:controls="using:DiffusionNexus.UI.Views.Controls"
        xmlns:converters="using:DiffusionNexus.UI.Converters"
        xmlns:vm="using:DiffusionNexus.UI.ViewModels"
        x:Class="DiffusionNexus.UI.Views.Dialogs.SaveAsDialog"
        x:DataType="local:SaveAsDialog"
        Width="520"
        SizeToContent="Height"
        WindowStartupLocation="CenterOwner"
        CanResize="False"
        Title="Save As"
        Background="#252526">

    <StackPanel Margin="20" Spacing="16">
        
        <!-- Destination Selection -->
        <StackPanel Spacing="12">
            <TextBlock Text="Save Destination" FontWeight="SemiBold"/>
            
            <Border Background="#1A1A1A"
                    CornerRadius="6"
                    Padding="12"
                    BorderThickness="1"
                    BorderBrush="{Binding IsOriginSelected, Converter={x:Static converters:BoolConverters.ToAccentBorder}}">
                <StackPanel Spacing="6">
                    <RadioButton Content="Create new file in origin folder"
                                 GroupName="DestinationOption"
                                 IsChecked="{Binding IsOriginSelected, Mode=TwoWay}"/>
                    <TextBlock Text="{Binding OriginFolderPath}"
                               FontSize="12"
                               Opacity="0.6"
                               TextWrapping="Wrap"/>
                </StackPanel>
            </Border>

            <Border Background="#1A1A1A"
                    CornerRadius="6"
                    Padding="12"
                    BorderThickness="1"
                    BorderBrush="{Binding IsDatasetSelected, Converter={x:Static converters:BoolConverters.ToAccentBorder}}"
                    IsEnabled="{Binding IsExistingDatasetEnabled}">
                <StackPanel Spacing="8">
                    <RadioButton Content="Add Image to existing Dataset"
                                 GroupName="DestinationOption"
                                 IsChecked="{Binding IsDatasetSelected, Mode=TwoWay}"/>

                    <StackPanel Spacing="8" IsVisible="{Binding IsDatasetSelected}" Margin="24,0,0,0">
                        <ComboBox ItemsSource="{Binding AvailableDatasets}"
                                  SelectedItem="{Binding SelectedDataset, Mode=TwoWay}"
                                  HorizontalAlignment="Stretch">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="vm:DatasetCardViewModel">
                                    <TextBlock Text="{Binding Name}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <TextBlock Text="Version:" VerticalAlignment="Center" Opacity="0.7"/>
                            <ComboBox ItemsSource="{Binding AvailableVersions}"
                                      SelectedItem="{Binding SelectedVersion, Mode=TwoWay}"
                                      MinWidth="80">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding StringFormat='V{0}'}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Save to custom folder -->
            <Border Background="#1A1A1A"
                    CornerRadius="6"
                    Padding="12"
                    BorderThickness="1"
                    BorderBrush="{Binding IsCustomFolderSelected, Converter={x:Static converters:BoolConverters.ToAccentBorder}}">
                <StackPanel Spacing="6">
                    <RadioButton Content="Save to Folder"
                                 GroupName="DestinationOption"
                                 IsChecked="{Binding IsCustomFolderSelected, Mode=TwoWay}"/>
                    <StackPanel Spacing="6" IsVisible="{Binding IsCustomFolderSelected}" Margin="24,0,0,0">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="{Binding CustomFolderPath}"
                                       FontSize="12"
                                       Opacity="0.6"
                                       TextWrapping="Wrap"
                                       VerticalAlignment="Center"/>
                            <Button Grid.Column="1"
                                    Content="Browse..."
                                    Padding="8,4"
                                    FontSize="11"
                                    Click="OnBrowseCustomFolder"/>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Save Layered TIFF -->
            <Border Background="#1A1A1A"
                    CornerRadius="6"
                    Padding="12"
                    BorderThickness="1"
                    BorderBrush="{Binding IsLayeredTiffSelected, Converter={x:Static converters:BoolConverters.ToAccentBorder}}"
                    IsVisible="{Binding HasLayers}">
                <StackPanel Spacing="6">
                    <RadioButton Content="Save Layered TIFF"
                                 GroupName="DestinationOption"
                                 IsChecked="{Binding IsLayeredTiffSelected, Mode=TwoWay}"/>
                    <StackPanel Spacing="6" IsVisible="{Binding IsLayeredTiffSelected}" Margin="24,0,0,0">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="{Binding LayeredTiffFolderPath}"
                                       FontSize="12"
                                       Opacity="0.6"
                                       TextWrapping="Wrap"
                                       VerticalAlignment="Center"/>
                            <Button Grid.Column="1"
                                    Content="Browse..."
                                    Padding="8,4"
                                    FontSize="11"
                                    Click="OnBrowseLayeredTiffFolder"/>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </Border>
        </StackPanel>

        <!-- Filename Input -->
        <StackPanel Spacing="8">
            <TextBlock Text="New filename:" FontWeight="SemiBold"/>
            <Grid ColumnDefinitions="*,Auto">
                <TextBox Grid.Column="0"
                         x:Name="FileNameTextBox"
                         Text="{Binding FileName, Mode=TwoWay}"
                         Watermark="Enter filename..."/>
                <TextBlock Grid.Column="1" 
                           Text="{Binding DisplayExtension}"
                           VerticalAlignment="Center"
                           Margin="8,0,0,0"
                           Opacity="0.7"/>
            </Grid>
            
            <!-- Validation warning (filename unchanged or already exists) -->
            <Border Background="#442222"
                    CornerRadius="4"
                    Padding="12,8"
                    IsVisible="{Binding HasValidationError}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="??" FontSize="14"/>
                    <TextBlock Text="{Binding ValidationMessage}"
                               Foreground="#ff6666"
                               FontSize="12"
                               TextWrapping="Wrap"/>
                </StackPanel>
            </Border>
        </StackPanel>

        <!-- Rating Section -->
        <StackPanel Spacing="8">
            <controls:RatingButtonsControl x:Name="RatingButtons"
                                           Rating="{Binding Rating, Mode=TwoWay}"
                                           ShowLabel="True"/>
        </StackPanel>

        <!-- Buttons -->
        <StackPanel Orientation="Horizontal" 
                    HorizontalAlignment="Right" 
                    Spacing="8"
                    Margin="0,8,0,0">
            <Button Content="Cancel" 
                    Width="80"
                    Click="OnCancelClick"/>
            <Button Content="Save" 
                    Width="80"
                    IsDefault="True"
                    IsEnabled="{Binding CanSave}"
                    Click="OnSaveClick"/>
        </StackPanel>
        
    </StackPanel>
</Window>
